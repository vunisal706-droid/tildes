<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>La Aventura de las Tildes - CEIP Capitulaciones</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #FF6B35; --secondary: #4ECDC4; --accent: #FFE66D;
            --dark: #2C3E50; --danger: #E74C3C; --success: #27AE60;
            --powerup: #9C27B0; --combo: #FF5722;
        }
        body {
            font-family: 'Nunito', sans-serif;
            background: #1a1a2e;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        #game-container {
            width: 100%; max-width: 900px; height: 100vh; max-height: 700px;
            position: relative; overflow: hidden; background: #2C3E50;
        }
        @media (min-width: 920px) {
            #game-container { border-radius: 20px; height: 95vh; box-shadow: 0 0 60px rgba(0,0,0,0.5); }
        }
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center;
            justify-content: center; padding: 20px; z-index: 10;
        }
        .screen.active { display: flex; }
        #menu-screen {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 400% 400%; animation: gradientShift 8s ease infinite;
        }
        @keyframes gradientShift { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
        .game-title {
            font-family: 'Fredoka One', cursive; font-size: clamp(1.8rem, 7vw, 3.5rem);
            color: white; text-shadow: 4px 4px 0 rgba(0,0,0,0.2); text-align: center; margin-bottom: 5px;
        }
        .game-subtitle { font-size: 1.3rem; color: var(--accent); margin-bottom: 8px; font-weight: 600; }
        .school-name { 
            font-size: 1rem; color: white; margin-bottom: 30px; font-weight: 700; 
            background: rgba(0,0,0,0.2); padding: 8px 20px; border-radius: 20px;
            letter-spacing: 1px;
        }
        .logo-icon { font-size: 4rem; display: block; margin-bottom: 20px; animation: logoFloat 3s ease-in-out infinite; }
        @keyframes logoFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        .menu-buttons { display: flex; flex-direction: column; gap: 12px; width: 100%; max-width: 280px; }
        .btn {
            font-family: 'Nunito', sans-serif; font-size: 1.1rem; font-weight: 700;
            padding: 14px 28px; border: none; border-radius: 50px; cursor: pointer;
            transition: all 0.2s ease; text-transform: uppercase;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, #ff8c5a 100%);
            color: white; box-shadow: 0 4px 0 #c44d1e;
        }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-primary:active { transform: translateY(2px); box-shadow: 0 2px 0 #c44d1e; }
        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary) 0%, #7ee8e0 100%);
            color: var(--dark); box-shadow: 0 4px 0 #35a79c;
        }
        .screen-title {
            font-family: 'Fredoka One', cursive; font-size: clamp(1.5rem, 5vw, 2.2rem);
            color: white; text-shadow: 3px 3px 0 rgba(0,0,0,0.2); margin-bottom: 30px;
        }
        #players-screen { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .players-grid { display: flex; gap: 15px; margin-bottom: 30px; }
        .player-option {
            width: 100px; height: 120px; background: white; border-radius: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s ease; box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border: 4px solid transparent;
        }
        .player-option:hover { transform: translateY(-5px); }
        .player-option.selected { border-color: var(--accent); background: var(--accent); }
        .player-option-num { font-family: 'Fredoka One', cursive; font-size: 2.5rem; color: var(--dark); }
        .player-option-label { font-size: 0.85rem; color: #666; font-weight: 600; }
        #mode-screen { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .mode-options { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-bottom: 30px; }
        .mode-option {
            width: 160px; padding: 25px 15px; background: white; border-radius: 20px;
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
            transition: all 0.2s ease; box-shadow: 0 8px 20px rgba(0,0,0,0.15); border: 4px solid transparent;
        }
        .mode-option:hover { transform: translateY(-5px); }
        .mode-option.selected { border-color: var(--accent); background: var(--accent); }
        .mode-icon { font-size: 2.5rem; margin-bottom: 10px; }
        .mode-title { font-size: 1.1rem; font-weight: 700; color: var(--dark); }
        .mode-desc { font-size: 0.75rem; color: #666; text-align: center; margin-top: 5px; }
        #instructions-screen { background: linear-gradient(135deg, #2C3E50 0%, #4CA1AF 100%); }
        .instructions-box {
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            border-radius: 20px; padding: 25px; max-width: 450px; color: white; margin-bottom: 25px;
        }
        .instructions-box h3 { font-family: 'Fredoka One', cursive; color: var(--accent); margin-bottom: 12px; font-size: 1.3rem; }
        .instructions-box p { margin-bottom: 8px; line-height: 1.5; font-size: 0.95rem; }
        .key-icon { display: inline-block; background: rgba(255,255,255,0.2); padding: 2px 10px; border-radius: 5px; font-family: monospace; font-weight: bold; }
        .game-hud {
            position: absolute; top: 0; left: 0; right: 0; padding: 8px 12px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); z-index: 100;
        }
        .hud-section { display: flex; align-items: center; gap: 12px; }
        .hud-item { display: flex; align-items: center; gap: 5px; color: white; font-weight: 700; font-size: 0.9rem; }
        .current-player { background: var(--accent); color: var(--dark); padding: 4px 12px; border-radius: 15px; font-weight: 800; }
        .lives-display { display: flex; gap: 2px; }
        .heart { font-size: 1.1rem; transition: all 0.3s ease; }
        .heart.lost { opacity: 0.3; transform: scale(0.7); filter: grayscale(1); }
        .world-badge { background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 10px; font-size: 0.85rem; }
        .word-badge {
            position: absolute; bottom: 70px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.75); backdrop-filter: blur(10px);
            padding: 8px 25px; border-radius: 25px; z-index: 50; border: 2px solid rgba(255,255,255,0.2);
        }
        .word-badge-text { font-size: 1.4rem; font-weight: 800; color: white; letter-spacing: 2px; }
        #game-area { width: 100%; height: 100%; position: relative; overflow: hidden; }
        .world-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* CASTILLO - G√≥tico oscuro */
        .bg-castle { background: linear-gradient(180deg, #0f0c29 0%, #302b63 50%, #24243e 100%); }
        .castle-tower { position: absolute; bottom: 0; width: 80px; height: 200px; background: linear-gradient(90deg, #2d2d2d 0%, #1a1a1a 50%, #2d2d2d 100%); clip-path: polygon(20% 100%, 20% 30%, 50% 0%, 80% 30%, 80% 100%); }
        .castle-window { position: absolute; width: 15px; height: 25px; background: #FFD700; border-radius: 50% 50% 0 0; box-shadow: 0 0 20px #FFD700; animation: windowFlicker 3s ease-in-out infinite; }
        @keyframes windowFlicker { 0%, 100% { opacity: 0.8; } 50% { opacity: 1; } }
        
        /* BOSQUE - Natural y org√°nico */
        .bg-forest { background: linear-gradient(180deg, #87CEEB 0%, #98D8AA 40%, #1B4D3E 100%); }
        .tree { position: absolute; bottom: 0; width: 60px; height: 150px; background: linear-gradient(90deg, #5D4037 0%, #3E2723 100%); border-radius: 10px; }
        .tree::before { content: ''; position: absolute; top: -80px; left: 50%; transform: translateX(-50%); width: 120px; height: 100px; background: #2E7D32; border-radius: 50%; }
        .tree::after { content: ''; position: absolute; top: -60px; left: 30%; width: 80px; height: 80px; background: #388E3C; border-radius: 50%; }
        
        /* OC√âANO - Submarino */
        .bg-ocean { background: linear-gradient(180deg, #4FC3F7 0%, #0288D1 30%, #01579B 70%, #002f6c 100%); }
        .coral { position: absolute; bottom: 0; width: 40px; height: 80px; background: linear-gradient(180deg, #FF7043 0%, #E64A19 100%); border-radius: 20px 20px 0 0; animation: coralSway 4s ease-in-out infinite; }
        @keyframes coralSway { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        .seaweed { position: absolute; bottom: 0; width: 20px; height: 100px; background: linear-gradient(180deg, #66BB6A 0%, #2E7D32 100%); border-radius: 50% 50% 0 0; animation: seaweedWave 3s ease-in-out infinite; }
        @keyframes seaweedWave { 0%, 100% { transform: rotate(-10deg) scaleX(1); } 50% { transform: rotate(10deg) scaleX(0.8); } }
        
        /* ESPACIO - C√≥smico */
        .bg-space { background: linear-gradient(180deg, #0d0d2b 0%, #1a1a4e 50%, #2d1b4e 100%); }
        .planet-bg { position: absolute; border-radius: 50%; box-shadow: inset -20px -20px 40px rgba(0,0,0,0.5); }
        .asteroid { position: absolute; width: 30px; height: 25px; background: #795548; border-radius: 40% 60% 50% 40%; animation: asteroidFloat 20s linear infinite; }
        @keyframes asteroidFloat { 0% { transform: translateX(-50px) rotate(0deg); } 100% { transform: translateX(calc(100vw + 50px)) rotate(360deg); } }
        
        /* CANDY - Dulce y colorido */
        .bg-candy { background: linear-gradient(180deg, #FFECB3 0%, #F8BBD9 50%, #E1BEE7 100%); }
        .candy-cane { position: absolute; bottom: 20px; width: 15px; height: 100px; background: repeating-linear-gradient(45deg, #fff 0px, #fff 10px, #E91E63 10px, #E91E63 20px); border-radius: 10px; transform: rotate(-10deg); }
        .gumdrop { position: absolute; bottom: 0; width: 50px; height: 40px; background: linear-gradient(180deg, #9C27B0 0%, #7B1FA2 100%); border-radius: 50% 50% 10px 10px; }
        
        /* PLATAFORMAS - TODAS IGUALES DE LARGAS */
        .platform { position: absolute; height: 18px; z-index: 5; }
        
        /* Castillo - Piedra g√≥tica */
        .platform-castle { 
            background: linear-gradient(180deg, #6D6D6D 0%, #4A4A4A 50%, #3D3D3D 100%); 
            border-top: 4px solid #8a8a8a; 
            box-shadow: 0 6px 0 #2d2d2d, 0 0 20px rgba(0,0,0,0.5);
            border-radius: 8px;
        }
        .platform-castle::before { content: ''; position: absolute; top: -15px; left: 10px; width: 15px; height: 15px; background: #4A4A4A; clip-path: polygon(50% 0%, 0% 100%, 100% 100%); }
        .platform-castle::after { content: ''; position: absolute; top: -15px; right: 10px; width: 15px; height: 15px; background: #4A4A4A; clip-path: polygon(50% 0%, 0% 100%, 100% 100%); }
        
        /* Bosque - Troncos y ramas */
        .platform-forest { 
            background: linear-gradient(180deg, #8D6E63 0%, #6D4C41 50%, #5D4037 100%); 
            border-top: 4px solid #A1887F; 
            box-shadow: 0 6px 0 #4E342E;
            border-radius: 15px;
        }
        .platform-forest::before { content: 'üåø'; position: absolute; top: -20px; left: 20%; font-size: 20px; animation: leafSway 2s ease-in-out infinite; }
        .platform-forest::after { content: 'üåø'; position: absolute; top: -18px; right: 25%; font-size: 16px; animation: leafSway 2.5s ease-in-out infinite reverse; }
        @keyframes leafSway { 0%, 100% { transform: rotate(-10deg); } 50% { transform: rotate(10deg); } }
        
        /* Oc√©ano - Rocas coralinas */
        .platform-ocean { 
            background: linear-gradient(180deg, #0097A7 0%, #00838F 50%, #006064 100%); 
            border-top: 4px solid #26C6DA; 
            box-shadow: 0 6px 0 #004D40, 0 0 15px rgba(0,188,212,0.4);
            border-radius: 50% 50% 10px 10px / 20% 20% 10px 10px;
        }
        .platform-ocean::before { content: ''; position: absolute; top: -8px; left: 15%; width: 8px; height: 8px; background: #FF7043; border-radius: 50%; box-shadow: 20px 0 0 #FF7043, 40px -3px 0 #FFCA28; }
        
        /* Espacio - Plataformas flotantes tecnol√≥gicas */
        .platform-space { 
            background: linear-gradient(180deg, #7E57C2 0%, #5E35B1 50%, #4527A0 100%); 
            border: 2px solid #B39DDB; 
            box-shadow: 0 0 20px #7E57C2, 0 6px 0 #311B92, inset 0 2px 10px rgba(255,255,255,0.2);
            border-radius: 10px;
            animation: platformFloat 3s ease-in-out infinite;
        }
        @keyframes platformFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .platform-space::before { content: ''; position: absolute; top: 50%; left: -10px; width: 20px; height: 4px; background: #B39DDB; border-radius: 2px; box-shadow: 0 0 10px #B39DDB; }
        .platform-space::after { content: ''; position: absolute; top: 30%; right: -8px; width: 15px; height: 3px; background: #B39DDB; border-radius: 2px; }
        
        /* Candy - Dulces y gominolas */
        .platform-candy { 
            background: linear-gradient(180deg, #F48FB1 0%, #F06292 50%, #EC407A 100%); 
            border-top: 4px solid #F8BBD9; 
            box-shadow: 0 6px 0 #C2185B, 0 0 15px rgba(244,143,177,0.5);
            border-radius: 25px;
            border: 3px dashed white;
        }
        .platform-candy::before { content: 'üç¨'; position: absolute; top: -25px; left: 30%; font-size: 22px; animation: candyBounce 1s ease-in-out infinite; }
        @keyframes candyBounce { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-5px) rotate(10deg); } }
        
        /* ESCALERAS ESTILIZADAS */
        .ladder { position: absolute; z-index: 4; }
        .ladder-castle { 
            width: 32px;
            background: repeating-linear-gradient(180deg, #5D4037 0px, #5D4037 6px, transparent 6px, transparent 24px);
            border-left: 3px solid #3E2723; border-right: 3px solid #3E2723;
        }
        .ladder-forest { 
            width: 28px;
            background: repeating-linear-gradient(180deg, #8D6E63 0px, #8D6E63 4px, transparent 4px, transparent 20px);
            border-left: 4px solid #6D4C41; border-right: 4px solid #6D4C41;
            transform: rotate(2deg);
        }
        .ladder-ocean { 
            width: 30px;
            background: linear-gradient(90deg, transparent 40%, #4DD0E1 40%, #4DD0E1 60%, transparent 60%);
            background-size: 100% 20px;
            animation: bubbleUp 2s linear infinite;
        }
        @keyframes bubbleUp { 0% { background-position: 0 0; } 100% { background-position: 0 20px; } }
        .ladder-space { 
            width: 26px;
            background: linear-gradient(180deg, rgba(126,87,194,0.8) 0%, rgba(126,87,194,0.2) 100%);
            border: 2px dashed #B39DDB;
            border-radius: 10px;
            animation: ladderPulse 2s ease-in-out infinite;
        }
        @keyframes ladderPulse { 0%, 100% { opacity: 0.7; } 50% { opacity: 1; } }
        .ladder-candy { 
            width: 34px;
            background: repeating-linear-gradient(180deg, #FFEB3B 0px, #FFEB3B 8px, #F44336 8px, #F44336 16px);
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(255,235,59,0.5);
        }
        
        .player { position: absolute; width: 40px; height: 55px; z-index: 20; transition: transform 0.1s ease; }
        .player-sprite { width: 100%; height: 100%; position: relative; }
        .player-head { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 28px; height: 28px; background: #FFCC80; border-radius: 50%; box-shadow: inset -3px -3px 8px rgba(0,0,0,0.1); }
        .player-hair { position: absolute; top: -2px; left: 50%; transform: translateX(-50%); width: 30px; height: 18px; background: #5D4037; border-radius: 50% 50% 30% 30%; z-index: -1; }
        .player-eyes { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px; }
        .player-eye { width: 6px; height: 7px; background: #333; border-radius: 50%; }
        .player-body { position: absolute; top: 26px; left: 50%; transform: translateX(-50%); width: 24px; height: 18px; background: linear-gradient(180deg, #2196F3 0%, #1976D2 100%); border-radius: 5px 5px 0 0; }
        .player-arms { position: absolute; top: 28px; left: 50%; transform: translateX(-50%); width: 40px; display: flex; justify-content: space-between; }
        .player-arm { width: 8px; height: 14px; background: linear-gradient(180deg, #2196F3 0%, #1976D2 100%); border-radius: 4px; transform-origin: top center; }
        .player-hand { width: 7px; height: 7px; background: #FFCC80; border-radius: 50%; margin-top: -1px; }
        .player-legs { position: absolute; top: 42px; left: 50%; transform: translateX(-50%); width: 20px; display: flex; justify-content: space-between; }
        .player-leg { width: 8px; height: 13px; background: #37474F; border-radius: 0 0 3px 3px; transform-origin: top center; }
        .player-shoe { width: 10px; height: 5px; background: #E53935; border-radius: 3px; margin-top: -1px; margin-left: -1px; }
        .player.walking .player-leg:first-child { animation: legWalk 0.25s ease-in-out infinite; }
        .player.walking .player-leg:last-child { animation: legWalk 0.25s ease-in-out infinite reverse; }
        .player.walking .player-arm:first-child { animation: armSwing 0.25s ease-in-out infinite reverse; }
        .player.walking .player-arm:last-child { animation: armSwing 0.25s ease-in-out infinite; }
        @keyframes legWalk { 0%, 100% { transform: rotate(-20deg); } 50% { transform: rotate(20deg); } }
        @keyframes armSwing { 0%, 100% { transform: rotate(-15deg); } 50% { transform: rotate(15deg); } }
        
        /* PERSONAJE TILDE - PL√ÅTANO MEDIA LUNA */
        .tilde-character {
            position: absolute;
            width: 50px;
            height: 65px;
            z-index: 15;
            cursor: pointer;
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3));
            transition: opacity 0.3s ease;
        }
        .banana-tilde-body {
            position: absolute;
            top: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 44px;
            height: 36px;
            background: linear-gradient(160deg, #FFE082 0%, #FFD54F 20%, #FFCA28 50%, #FFB300 80%, #E8A317 100%);
            border-radius: 80% 10% 10% 80% / 50% 40% 40% 50%;
            border: 2.5px solid #C68A0A;
            box-shadow: inset -4px -2px 8px rgba(0,0,0,0.12), inset 4px 3px 6px rgba(255,255,255,0.35);
            overflow: visible;
        }
        .banana-tilde-inner {
            position: absolute;
            top: 6px;
            left: 6px;
            right: 10px;
            height: 22px;
            border-left: 2px solid rgba(198,138,10,0.3);
            border-radius: 70% 0% 0% 70% / 50% 0% 0% 50%;
        }
        .banana-tilde-highlight {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 6px;
            height: 20px;
            background: rgba(255,255,255,0.35);
            border-radius: 50%;
            transform: rotate(-10deg);
        }
        .banana-tilde-tip-top {
            position: absolute;
            top: -6px;
            left: 2px;
            width: 10px;
            height: 8px;
            background: #8B6914;
            border-radius: 50% 50% 20% 60%;
            transform: rotate(-30deg);
        }
        .banana-tilde-tip-bottom {
            position: absolute;
            bottom: -4px;
            right: 0px;
            width: 9px;
            height: 7px;
            background: #A67C00;
            border-radius: 60% 20% 50% 50%;
            transform: rotate(15deg);
        }
        .banana-tilde-face {
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-45%);
            width: 36px;
            height: 28px;
        }
        .banana-tilde-eyes {
            position: absolute;
            top: 4px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }
        .banana-tilde-eye {
            width: 11px;
            height: 12px;
            background: white;
            border-radius: 50%;
            position: relative;
            box-shadow: inset 0 -2px 3px rgba(0,0,0,0.1);
            border: 2px solid #5D4037;
        }
        .banana-tilde-pupil {
            position: absolute;
            width: 5px;
            height: 6px;
            background: #1a1a2e;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            animation: tildeLook 3s ease-in-out infinite;
        }
        .banana-tilde-pupil::after {
            content: '';
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            top: 0;
            left: 0;
        }
        @keyframes tildeLook {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(2px); }
            75% { transform: translateX(-2px); }
        }
        .banana-tilde-mouth {
            position: absolute;
            bottom: 3px;
            left: 50%;
            transform: translateX(-50%);
            width: 14px;
            height: 8px;
            border: 2.5px solid #5D4037;
            border-top: none;
            border-radius: 0 0 14px 14px;
            background: #FF7043;
        }
        .banana-tilde-legs {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }
        .banana-tilde-leg {
            width: 10px;
            height: 18px;
            background: linear-gradient(180deg, #FFCA28 0%, #FFB300 100%);
            border-radius: 5px 5px 6px 6px;
            position: relative;
            border: 2px solid #C68A0A;
            box-shadow: inset 2px 0 3px rgba(255,255,255,0.3);
        }
        .banana-tilde-shoe {
            position: absolute;
            bottom: -4px;
            left: -3px;
            width: 16px;
            height: 9px;
            background: linear-gradient(180deg, #6D4C41 0%, #5D4037 100%);
            border-radius: 5px 9px 4px 4px;
            box-shadow: 0 2px 3px rgba(0,0,0,0.3);
            border: 1px solid #4E342E;
        }
        .banana-tilde-shoe::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 5px;
            height: 2px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }
        .tilde-character.running .banana-tilde-leg:first-child { animation: tildeRunLeg 0.18s ease-in-out infinite; }
        .tilde-character.running .banana-tilde-leg:last-child { animation: tildeRunLeg 0.18s ease-in-out infinite reverse; }
        @keyframes tildeRunLeg {
            0%, 100% { transform: rotate(-30deg) translateY(-2px); }
            50% { transform: rotate(30deg) translateY(0); }
        }
        .tilde-character.running .banana-tilde-body { animation: tildeBounce 0.18s ease-in-out infinite; }
        @keyframes tildeBounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-4px); }
        }
        .tilde-character.collected { animation: tildeCollected 0.5s ease forwards; }
        @keyframes tildeCollected {
            0% { transform: scale(1) rotate(0); opacity: 1; }
            30% { transform: scale(1.4) rotate(-15deg); }
            60% { transform: scale(1.5) rotate(15deg); }
            100% { transform: scale(0) rotate(720deg); opacity: 0; }
        }
        .tilde-character.appearing { animation: tildeAppear 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes tildeAppear {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; filter: brightness(2); }
            60% { transform: scale(1.3) rotate(15deg); filter: brightness(1.5); }
            100% { transform: scale(1) rotate(0); opacity: 1; filter: brightness(1); }
        }
        .tilde-sparkles { position: absolute; width: 100%; height: 100%; pointer-events: none; }
        .tilde-sparkle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: radial-gradient(circle, #FFE082 0%, #FFD54F 100%);
            border-radius: 50%;
            animation: sparkle 1.2s ease-in-out infinite;
            box-shadow: 0 0 4px #FFD54F;
        }
        .tilde-sparkle:nth-child(1) { top: -8px; left: 15px; animation-delay: 0s; }
        .tilde-sparkle:nth-child(2) { top: 0px; right: -5px; animation-delay: 0.3s; }
        .tilde-sparkle:nth-child(3) { bottom: 25px; left: -5px; animation-delay: 0.6s; }
        .tilde-sparkle:nth-child(4) { top: 10px; right: -8px; animation-delay: 0.9s; }
        @keyframes sparkle {
            0%, 100% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
        }
        
        .enemy { position: absolute; z-index: 18; }
        .pencil-enemy { width: 18px; height: 55px; }
        .pencil-body { width: 100%; height: 40px; background: linear-gradient(90deg, #FDD835 0%, #FFEB3B 30%, #FDD835 70%, #F9A825 100%); border-radius: 3px; position: relative; }
        .pencil-top { position: absolute; top: -8px; left: 50%; transform: translateX(-50%); width: 18px; height: 10px; background: linear-gradient(90deg, #FFA726 0%, #FFB74D 50%, #FFA726 100%); border-radius: 2px 2px 0 0; }
        .pencil-tip { position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 9px solid transparent; border-right: 9px solid transparent; border-top: 18px solid #F5DEB3; }
        .pencil-face { position: absolute; top: 8px; left: 50%; transform: translateX(-50%); width: 14px; }
        .pencil-brows { display: flex; justify-content: center; gap: 2px; margin-bottom: 2px; }
        .pencil-brow { width: 5px; height: 2px; background: #333; border-radius: 1px; }
        .pencil-brow:first-child { transform: rotate(20deg); }
        .pencil-brow:last-child { transform: rotate(-20deg); }
        .pencil-eyes { display: flex; justify-content: center; gap: 3px; }
        .pencil-eye { width: 4px; height: 4px; background: #333; border-radius: 50%; }
        .pencil-enemy.falling { animation: pencilWobble 0.3s ease-in-out infinite alternate; }
        @keyframes pencilWobble { 0% { transform: rotate(-8deg); } 100% { transform: rotate(8deg); } }
        .touch-controls { position: absolute; bottom: 8px; left: 0; right: 0; display: none; justify-content: space-between; padding: 0 15px; z-index: 200; pointer-events: none; }
        .touch-controls.active { display: flex; }
        .control-group { display: flex; gap: 8px; pointer-events: auto; }
        .touch-btn { width: 50px; height: 50px; background: rgba(255,255,255,0.25); border: 2px solid rgba(255,255,255,0.4); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; color: white; cursor: pointer; user-select: none; }
        .touch-btn:active { background: rgba(255,255,255,0.45); transform: scale(0.95); }
        .touch-btn-jump { width: 65px; height: 65px; font-size: 1.6rem; }
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 300; backdrop-filter: blur(5px); }
        .modal-overlay.active { display: flex; animation: modalFadeIn 0.3s ease; }
        @keyframes modalFadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background: white; border-radius: 25px; padding: 30px; max-width: 400px; width: 90%; text-align: center; animation: modalSlideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes modalSlideIn { from { transform: scale(0.8) translateY(20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
        .modal-title { font-family: 'Fredoka One', cursive; font-size: 1.3rem; color: var(--dark); margin-bottom: 20px; }
        .modal-word { font-size: 2rem; font-weight: 900; color: var(--dark); margin-bottom: 15px; display: flex; justify-content: center; gap: 2px; }
        .letter-box { padding: 8px 10px; border-radius: 8px; transition: all 0.2s ease; }
        .letter-box.vowel { background: #E3F2FD; cursor: pointer; }
        .letter-box.vowel:hover { background: #BBDEFB; transform: scale(1.1); }
        .letter-box.selected { background: var(--primary); color: white; }
        .classification-options { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 20px; }
        .class-option { padding: 12px 20px; background: #E8F5E9; border: 3px solid transparent; border-radius: 15px; font-family: 'Nunito', sans-serif; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.2s ease; }
        .class-option:hover { background: #C8E6C9; transform: translateY(-2px); }
        .class-option.selected { background: var(--success); color: white; border-color: #1B5E20; }
        .modal-btn { padding: 12px 35px; background: var(--success); color: white; border: none; border-radius: 25px; font-family: 'Nunito', sans-serif; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: all 0.2s ease; }
        .modal-btn:hover { background: #219653; transform: scale(1.05); }
        .modal-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .diacritic-sentence { font-size: 1.3rem; font-weight: 600; color: var(--dark); margin-bottom: 20px; line-height: 1.6; }
        .diacritic-options { display: flex; gap: 15px; justify-content: center; margin-bottom: 10px; }
        .diacritic-btn { padding: 15px 30px; background: #FFF3E0; border: 3px solid transparent; border-radius: 15px; font-family: 'Nunito', sans-serif; font-size: 1.4rem; font-weight: 800; cursor: pointer; transition: all 0.2s ease; }
        .diacritic-btn:hover { background: #FFE0B2; transform: scale(1.05); }
        .feedback { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-family: 'Fredoka One', cursive; font-size: 2.5rem; pointer-events: none; z-index: 400; opacity: 0; text-shadow: 3px 3px 0 rgba(0,0,0,0.2); }
        .feedback.show-correct { color: var(--success); animation: feedbackPop 1.2s ease forwards; }
        .feedback.show-incorrect { color: var(--danger); animation: feedbackPop 1.2s ease forwards; }
        @keyframes feedbackPop { 0% { transform: translate(-50%, -50%) scale(0); opacity: 0; } 15% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 70% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 100% { transform: translate(-50%, -70%) scale(1); opacity: 0; } }
        .transition-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 350; }
        .transition-overlay.active { display: flex; }
        .transition-content { text-align: center; color: white; }
        .transition-title { font-family: 'Fredoka One', cursive; font-size: 2rem; margin-bottom: 10px; }
        .transition-player { font-size: 1.8rem; color: var(--accent); margin-bottom: 25px; font-weight: 800; }
        .world-intro { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 360; color: white; text-align: center; }
        .world-intro.active { display: flex; animation: worldZoom 0.5s ease; }
        @keyframes worldZoom { from { opacity: 0; transform: scale(1.3); } to { opacity: 1; transform: scale(1); } }
        .world-intro-name { font-family: 'Fredoka One', cursive; font-size: clamp(2rem, 10vw, 4rem); text-shadow: 4px 4px 0 rgba(0,0,0,0.3); margin-bottom: 10px; }
        .world-intro-level { font-size: 1.5rem; opacity: 0.9; font-weight: 700; }
        .goal-zone { position: absolute; top: 65px; left: 50%; transform: translateX(-50%); padding: 10px 25px; background: linear-gradient(135deg, var(--accent) 0%, #FFB300 100%); border-radius: 12px; font-family: 'Fredoka One', cursive; font-size: 1.1rem; color: var(--dark); box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 10; animation: goalGlow 2s ease-in-out infinite; }
        @keyframes goalGlow { 0%, 100% { box-shadow: 0 4px 15px rgba(255,193,7,0.4); } 50% { box-shadow: 0 4px 25px rgba(255,193,7,0.7); } }
        .pause-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 500; }
        .pause-overlay.active { display: flex; }
        .pause-title { font-family: 'Fredoka One', cursive; font-size: 3rem; color: white; margin-bottom: 30px; }
        #results-screen { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #1a1a3e 100%); }
        .results-title { font-family: 'Fredoka One', cursive; font-size: clamp(2rem, 8vw, 3rem); color: var(--accent); text-shadow: 3px 3px 0 rgba(0,0,0,0.3); margin-bottom: 30px; }
        .podium { display: flex; align-items: flex-end; gap: 10px; margin-bottom: 30px; }
        .podium-place { display: flex; flex-direction: column; align-items: center; padding: 15px 20px; border-radius: 15px 15px 0 0; min-width: 90px; }
        .podium-place.first { background: linear-gradient(180deg, #FFD700 0%, #FFA500 100%); height: 140px; order: 2; }
        .podium-place.second { background: linear-gradient(180deg, #C0C0C0 0%, #A0A0A0 100%); height: 110px; order: 1; }
        .podium-place.third { background: linear-gradient(180deg, #CD7F32 0%, #8B4513 100%); height: 80px; order: 3; }
        .podium-medal { font-size: 1.8rem; margin-bottom: 5px; }
        .podium-name { font-weight: 700; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .podium-score { font-size: 1.3rem; font-weight: 800; color: white; }
        .coop-result { text-align: center; margin-bottom: 30px; }
        .coop-total { font-family: 'Fredoka One', cursive; font-size: 3rem; color: var(--accent); }
        .coop-goal { font-size: 1.2rem; color: white; opacity: 0.8; }
        .coop-status { font-size: 1.5rem; margin-top: 10px; }
        .collected-indicator { position: absolute; top: 50px; right: 15px; background: rgba(0,0,0,0.7); padding: 8px 15px; border-radius: 20px; display: none; align-items: center; gap: 8px; z-index: 100; }
        .collected-indicator.active { display: flex; }
        .collected-indicator span { color: white; font-weight: 700; font-size: 0.9rem; }
        .collected-preview { width: 30px; height: 30px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 1.1rem; }
        .star { position: absolute; width: 3px; height: 3px; background: white; border-radius: 50%; animation: twinkle 2s ease-in-out infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
        .moon { position: absolute; width: 60px; height: 60px; background: radial-gradient(circle at 30% 30%, #fffde7 0%, #ffd54f 100%); border-radius: 50%; box-shadow: 0 0 40px rgba(255, 213, 79, 0.4); }
        .sun { position: absolute; width: 70px; height: 70px; background: radial-gradient(circle, #FFF59D 0%, #FFD54F 60%, #FFB300 100%); border-radius: 50%; box-shadow: 0 0 60px rgba(255, 213, 79, 0.6); }
        .bubble { position: absolute; width: 15px; height: 15px; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.2) 100%); border-radius: 50%; animation: bubbleFloat 4s ease-in-out infinite; }
        @keyframes bubbleFloat { 0% { transform: translateY(0) scale(1); opacity: 0.7; } 100% { transform: translateY(-400px) scale(0.5); opacity: 0; } }
        .planet { position: absolute; border-radius: 50%; box-shadow: inset -10px -10px 20px rgba(0,0,0,0.4); }
        .lollipop { position: absolute; bottom: 0; }
        .lollipop-candy { width: 50px; height: 50px; border-radius: 50%; background: conic-gradient(#E91E63 0deg, white 30deg, #E91E63 60deg, white 90deg, #E91E63 120deg, white 150deg, #E91E63 180deg, white 210deg, #E91E63 240deg, white 270deg, #E91E63 300deg, white 330deg, #E91E63 360deg); }
        .lollipop-stick { width: 8px; height: 80px; background: #FFECB3; margin: 0 auto; border-radius: 0 0 4px 4px; }
        
        .sound-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 44px;
            height: 44px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: all 0.2s ease;
        }
        .sound-toggle:hover {
            background: rgba(255,255,255,0.35);
            transform: scale(1.1);
        }

        /* NUEVOS ELEMENTOS ADICTIVOS */
        
        /* Sistema de Combo */
        .combo-display {
            position: absolute;
            top: 50px;
            left: 15px;
            background: linear-gradient(135deg, var(--combo) 0%, #D84315 100%);
            padding: 8px 15px;
            border-radius: 20px;
            display: none;
            align-items: center;
            gap: 8px;
            z-index: 100;
            animation: comboPulse 0.5s ease;
            box-shadow: 0 4px 15px rgba(255,87,34,0.4);
        }
        .combo-display.active { display: flex; }
        .combo-display span { color: white; font-weight: 800; font-size: 1rem; }
        .combo-count { font-size: 1.3rem !important; text-shadow: 2px 2px 0 rgba(0,0,0,0.2); }
        @keyframes comboPulse {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Power-ups */
        .powerup {
            position: absolute;
            width: 35px;
            height: 35px;
            z-index: 16;
            cursor: pointer;
            animation: powerupFloat 2s ease-in-out infinite, powerupGlow 1.5s ease-in-out infinite;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            box-shadow: 0 0 20px rgba(156,39,176,0.6);
        }
        @keyframes powerupFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes powerupGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(156,39,176,0.6); }
            50% { box-shadow: 0 0 30px rgba(156,39,176,0.9), 0 0 40px rgba(156,39,176,0.4); }
        }
        .powerup-shield { background: linear-gradient(135deg, #42A5F5 0%, #1E88E5 100%); }
        .powerup-speed { background: linear-gradient(135deg, #66BB6A 0%, #43A047 100%); }
        .powerup-magnet { background: linear-gradient(135deg, #AB47BC 0%, #8E24AA 100%); }
        .powerup-time { background: linear-gradient(135deg, #FFA726 0%, #FB8C00 100%); }

        /* Efectos de power-up activos */
        .player.shielded .player-body {
            box-shadow: 0 0 0 4px #42A5F5, 0 0 20px #42A5F5;
            animation: shieldPulse 1s ease-in-out infinite;
        }
        @keyframes shieldPulse {
            0%, 100% { box-shadow: 0 0 0 4px #42A5F5, 0 0 20px #42A5F5; }
            50% { box-shadow: 0 0 0 8px #42A5F5, 0 0 30px #42A5F5; }
        }
        .player.speed-boost {
            filter: drop-shadow(0 0 10px #66BB6A);
        }

        /* Part√≠culas de explosi√≥n */
        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 50;
        }
        @keyframes particleExplode {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }

        /* Timer para la tilde */
        .tilde-timer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 4px;
            background: rgba(0,0,0,0.3);
            border-radius: 2px;
            overflow: hidden;
        }
        .tilde-timer-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%);
            transition: width 0.1s linear;
        }

        /* Multiplicador de puntos flotante */
        .floating-score {
            position: absolute;
            font-family: 'Fredoka One', cursive;
            font-size: 1.5rem;
            color: var(--accent);
            text-shadow: 2px 2px 0 rgba(0,0,0,0.3);
            pointer-events: none;
            z-index: 300;
            animation: floatUp 1s ease-out forwards;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.2); opacity: 0; }
        }

        /* Barra de progreso del mundo */
        .world-progress {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            overflow: hidden;
            z-index: 100;
        }
        .world-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent) 0%, #FFB300 100%);
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        /* Streak de respuestas correctas */
        .streak-indicator {
            position: absolute;
            top: 85px;
            right: 15px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA000 100%);
            padding: 5px 12px;
            border-radius: 15px;
            display: none;
            align-items: center;
            gap: 5px;
            z-index: 100;
            animation: streakBounce 0.5s ease;
        }
        .streak-indicator.active { display: flex; }
        .streak-indicator span { color: var(--dark); font-weight: 800; font-size: 0.9rem; }
        @keyframes streakBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* Mensaje de nivel perfecto */
        .perfect-level {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #FFD700 0%, #FF8F00 100%);
            padding: 15px 30px;
            border-radius: 25px;
            font-family: 'Fredoka One', cursive;
            font-size: 1.5rem;
            color: white;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.2);
            z-index: 400;
            display: none;
            animation: perfectPop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 30px rgba(255,215,0,0.4);
        }
        .perfect-level.active { display: block; }
        @keyframes perfectPop {
            0% { transform: translateX(-50%) scale(0) rotate(-10deg); }
            70% { transform: translateX(-50%) scale(1.1) rotate(5deg); }
            100% { transform: translateX(-50%) scale(1) rotate(0); }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="menu-screen" class="screen active">
            <span class="logo-icon">‚úèÔ∏è</span>
            <h1 class="game-title">La Aventura de las Tildes</h1>
            <p class="game-subtitle">con Capitul√≠n</p>
            <p class="school-name">ü¶ä CEIP CAPITULACIONES ü¶ä</p>
            <div class="menu-buttons">
                <button class="btn btn-primary" onclick="showScreen('players-screen'); playSound('click');">üéÆ JUGAR</button>
                <button class="btn btn-secondary" onclick="showScreen('instructions-screen'); playSound('click');">üìñ INSTRUCCIONES</button>
            </div>
            <button class="sound-toggle" onclick="toggleSound()" id="sound-btn">üîä</button>
        </div>
        <div id="instructions-screen" class="screen">
            <h2 class="screen-title">üìñ C√≥mo Jugar</h2>
            <div class="instructions-box">
                <h3>üéØ Objetivo</h3>
                <p>¬°Persigue y atrapa la tilde que huye! Aparece y desaparece por las plataformas. Luego col√≥cala en la palabra y clasif√≠cala.</p>
                <h3>üéÆ Controles</h3>
                <p><span class="key-icon">‚Üê</span> <span class="key-icon">‚Üí</span> Mover</p>
                <p><span class="key-icon">‚Üë</span> <span class="key-icon">‚Üì</span> Subir/Bajar escalera</p>
                <p><span class="key-icon">Espacio</span> Saltar</p>
                <h3>‚ö° Power-ups</h3>
                <p>üõ°Ô∏è Escudo - Protecci√≥n temporal</p>
                <p>‚ö° Velocidad - Corre m√°s r√°pido</p>
                <p>üß≤ Im√°n - Atrae la tilde</p>
                <p>‚è∞ Tiempo - La tilde dura m√°s</p>
                <h3>üî• Combo</h3>
                <p>¬°Responde correctamente varias veces seguidas para multiplicar tus puntos!</p>
                <h3>‚ö†Ô∏è ¬°Cuidado!</h3>
                <p>Esquiva los l√°pices enfadados que caen.</p>
            </div>
            <button class="btn btn-primary" onclick="showScreen('menu-screen'); playSound('click');">VOLVER</button>
        </div>
        <div id="players-screen" class="screen">
            <h2 class="screen-title">¬øCu√°ntos jugadores?</h2>
            <div class="players-grid">
                <div class="player-option" data-players="1" onclick="selectPlayers(1)"><span class="player-option-num">1</span><span class="player-option-label">Jugador</span></div>
                <div class="player-option" data-players="2" onclick="selectPlayers(2)"><span class="player-option-num">2</span><span class="player-option-label">Jugadores</span></div>
                <div class="player-option" data-players="3" onclick="selectPlayers(3)"><span class="player-option-num">3</span><span class="player-option-label">Jugadores</span></div>
            </div>
            <button class="btn btn-secondary" onclick="showScreen('menu-screen'); playSound('click');">VOLVER</button>
        </div>
        <div id="mode-screen" class="screen">
            <h2 class="screen-title">Elige el modo</h2>
            <div class="mode-options">
                <div class="mode-option" data-mode="competitive" onclick="selectMode('competitive')"><span class="mode-icon">‚öîÔ∏è</span><span class="mode-title">Competitivo</span><span class="mode-desc">Mayor puntuaci√≥n gana</span></div>
                <div class="mode-option" data-mode="cooperative" onclick="selectMode('cooperative')"><span class="mode-icon">ü§ù</span><span class="mode-title">Cooperativo</span><span class="mode-desc">Sumad puntos juntos</span></div>
            </div>
            <button class="btn btn-secondary" onclick="showScreen('players-screen'); playSound('click');">VOLVER</button>
        </div>
        <div id="game-screen" class="screen">
            <div class="game-hud">
                <div class="hud-section">
                    <div class="current-player" id="current-player-badge">J1</div>
                    <div class="hud-item"><div class="lives-display" id="lives-display"><span class="heart">‚ù§Ô∏è</span><span class="heart">‚ù§Ô∏è</span><span class="heart">‚ù§Ô∏è</span></div></div>
                </div>
                <div class="hud-section">
                    <div class="hud-item world-badge" id="world-badge">üè∞ Castillo</div>
                    <div class="hud-item">‚≠ê <span id="score-display">0</span></div>
                    <div class="hud-item">üìä <span id="level-display">1/25</span></div>
                </div>
            </div>
            <!-- Nuevos elementos de HUD -->
            <div class="combo-display" id="combo-display">
                <span>üî•</span>
                <span class="combo-count" id="combo-count">x2</span>
            </div>
            <div class="streak-indicator" id="streak-indicator">
                <span>‚ö°</span>
                <span id="streak-count">3</span>
            </div>
            <div class="world-progress" id="world-progress">
                <div class="world-progress-bar" id="world-progress-bar" style="width: 0%"></div>
            </div>
            <div class="perfect-level" id="perfect-level">üåü ¬°NIVEL PERFECTO! üåü</div>
            
            <div class="collected-indicator" id="collected-indicator"><span>Tilde:</span><div class="collected-preview" id="collected-preview">¬¥</div></div>
            <div id="game-area"></div>
            <div class="word-badge"><span class="word-badge-text" id="word-display">palabra</span></div>
            <div class="touch-controls" id="touch-controls">
                <div class="control-group"><button class="touch-btn" id="btn-left">‚óÄ</button><button class="touch-btn" id="btn-right">‚ñ∂</button></div>
                <div class="control-group"><button class="touch-btn" id="btn-up">‚ñ≤</button><button class="touch-btn" id="btn-down">‚ñº</button></div>
                <div class="control-group"><button class="touch-btn touch-btn-jump" id="btn-jump">‚¨Ü</button></div>
            </div>
            <div class="modal-overlay" id="tilde-modal"><div class="modal-content"><div class="modal-title">¬øD√≥nde va la tilde?</div><div class="modal-word" id="tilde-word"></div><button class="modal-btn" id="tilde-confirm-btn" onclick="confirmTildePlacement()" disabled>CONFIRMAR</button></div></div>
            <div class="modal-overlay" id="classify-modal"><div class="modal-content"><div class="modal-title">¬øQu√© tipo de palabra es?</div><div class="modal-word" id="classify-word-display"></div><div class="classification-options" id="class-options"><button class="class-option" onclick="selectClassification('aguda')">AGUDA</button><button class="class-option" onclick="selectClassification('llana')">LLANA</button><button class="class-option" onclick="selectClassification('esdrujula')">ESDR√öJULA</button><button class="class-option" onclick="selectClassification('hiato')">HIATO</button></div><button class="modal-btn" id="class-confirm-btn" onclick="confirmClassification()" disabled>CONFIRMAR</button></div></div>
            <div class="modal-overlay" id="diacritic-modal"><div class="modal-content"><div class="modal-title">Completa la frase</div><div class="diacritic-sentence" id="diacritic-sentence"></div><div class="diacritic-options" id="diacritic-options"></div></div></div>
            <div class="feedback" id="feedback"></div>
            <div class="world-intro" id="world-intro"><div class="world-intro-name" id="world-intro-name">üè∞ Castillo</div><div class="world-intro-level" id="world-intro-level">Nivel 1</div></div>
            <div class="transition-overlay" id="player-transition"><div class="transition-content"><div class="transition-title">¬°Cambio de turno!</div><div class="transition-player" id="transition-player">Jugador 2</div><button class="btn btn-primary" onclick="continueAfterTransition()">¬°LISTO!</button></div></div>
            <div class="pause-overlay" id="pause-overlay"><div class="pause-title">‚è∏Ô∏è PAUSA</div><div class="menu-buttons"><button class="btn btn-primary" onclick="resumeGame()">CONTINUAR</button><button class="btn btn-secondary" onclick="quitToMenu()">SALIR</button></div></div>
        </div>
        <div id="results-screen" class="screen">
            <h2 class="results-title">üèÜ Resultados</h2>
            <div id="results-content"></div>
            <div class="menu-buttons"><button class="btn btn-primary" onclick="playAgain()">JUGAR DE NUEVO</button><button class="btn btn-secondary" onclick="showScreen('menu-screen')">MEN√ö</button></div>
        </div>
    </div>
    <script>
        // ==================== SISTEMA DE SONIDO ====================
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;
        let soundEnabled = true;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-btn').textContent = soundEnabled ? 'üîä' : 'üîá';
            if (soundEnabled) initAudio();
        }

        function playSound(type) {
            if (!soundEnabled) return;
            initAudio();
            if (!audioCtx) return;
            
            const now = audioCtx.currentTime;
            
            switch(type) {
                case 'jump':
                    playTone([400, 600], [0.1, 0.1], 'sine', 0.3);
                    break;
                case 'collect':
                    playTone([523, 659, 784, 1047], [0.1, 0.1, 0.1, 0.2], 'sine', 0.4);
                    break;
                case 'correct':
                    playTone([523, 659, 784], [0.15, 0.15, 0.3], 'sine', 0.5);
                    break;
                case 'wrong':
                    playTone([300, 200], [0.2, 0.3], 'sawtooth', 0.3);
                    break;
                case 'hit':
                    playNoise(0.15, 0.4);
                    playTone([200, 100], [0.1, 0.15], 'square', 0.3);
                    break;
                case 'click':
                    playTone([800, 1000], [0.05, 0.05], 'sine', 0.2);
                    break;
                case 'appear':
                    playTone([300, 500, 700], [0.08, 0.08, 0.15], 'sine', 0.3);
                    break;
                case 'disappear':
                    playTone([600, 400, 200], [0.08, 0.08, 0.1], 'sine', 0.2);
                    break;
                case 'levelup':
                    playTone([523, 659, 784, 1047, 1319], [0.12, 0.12, 0.12, 0.12, 0.4], 'sine', 0.5);
                    break;
                case 'walk':
                    playTone([100, 120], [0.03, 0.03], 'triangle', 0.1);
                    break;
                case 'powerup':
                    playTone([440, 554, 659, 880], [0.1, 0.1, 0.1, 0.3], 'sine', 0.4);
                    break;
                case 'combo':
                    playTone([523, 659, 784, 1047, 1319], [0.08, 0.08, 0.08, 0.08, 0.2], 'sine', 0.5);
                    break;
            }
        }

        function playTone(frequencies, durations, waveType, volume) {
            if (!audioCtx) return;
            
            const gainNode = audioCtx.createGain();
            gainNode.connect(audioCtx.destination);
            gainNode.gain.value = volume;
            
            let time = audioCtx.currentTime;
            
            frequencies.forEach((freq, i) => {
                const osc = audioCtx.createOscillator();
                const oscGain = audioCtx.createGain();
                
                osc.type = waveType;
                osc.frequency.value = freq;
                
                osc.connect(oscGain);
                oscGain.connect(gainNode);
                
                oscGain.gain.setValueAtTime(volume, time);
                oscGain.gain.exponentialRampToValueAtTime(0.01, time + durations[i]);
                
                osc.start(time);
                osc.stop(time + durations[i]);
                
                time += durations[i] * 0.7;
            });
        }

        function playNoise(duration, volume) {
            if (!audioCtx) return;
            
            const bufferSize = audioCtx.sampleRate * duration;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }
            
            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            
            const gainNode = audioCtx.createGain();
            gainNode.gain.setValueAtTime(volume, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            
            noise.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            noise.start();
        }

        // ==================== BANCO DE PALABRAS ====================
        const WORD_BANK = {
            agudas: [
                {word:'cafe',correct:'caf√©',type:'aguda'},{word:'sofa',correct:'sof√°',type:'aguda'},{word:'mama',correct:'mam√°',type:'aguda'},
                {word:'papa',correct:'pap√°',type:'aguda'},{word:'alla',correct:'all√°',type:'aguda'},{word:'sera',correct:'ser√°',type:'aguda'},
                {word:'esta',correct:'est√°',type:'aguda'},{word:'aqui',correct:'aqu√≠',type:'aguda'},{word:'alli',correct:'all√≠',type:'aguda'},
                {word:'ahi',correct:'ah√≠',type:'aguda'},{word:'rubi',correct:'rub√≠',type:'aguda'},{word:'jabali',correct:'jabal√≠',type:'aguda'},
                {word:'colibri',correct:'colibr√≠',type:'aguda'},{word:'mani',correct:'man√≠',type:'aguda'},{word:'tabu',correct:'tab√∫',type:'aguda'},
                {word:'bambu',correct:'bamb√∫',type:'aguda'},{word:'menu',correct:'men√∫',type:'aguda'},{word:'iglu',correct:'igl√∫',type:'aguda'},
                {word:'peru',correct:'Per√∫',type:'aguda'},{word:'hindu',correct:'hind√∫',type:'aguda'},{word:'raton',correct:'rat√≥n',type:'aguda'},
                {word:'camion',correct:'cami√≥n',type:'aguda'},{word:'avion',correct:'avi√≥n',type:'aguda'},{word:'leon',correct:'le√≥n',type:'aguda'},
                {word:'melon',correct:'mel√≥n',type:'aguda'},{word:'sillon',correct:'sill√≥n',type:'aguda'},{word:'balon',correct:'bal√≥n',type:'aguda'},
                {word:'jamon',correct:'jam√≥n',type:'aguda'},{word:'limon',correct:'lim√≥n',type:'aguda'},{word:'buzon',correct:'buz√≥n',type:'aguda'},
                {word:'colchon',correct:'colch√≥n',type:'aguda'},{word:'salon',correct:'sal√≥n',type:'aguda'},{word:'rincon',correct:'rinc√≥n',type:'aguda'},
                {word:'tacon',correct:'tac√≥n',type:'aguda'},{word:'algodon',correct:'algod√≥n',type:'aguda'},{word:'boton',correct:'bot√≥n',type:'aguda'},
                {word:'corazon',correct:'coraz√≥n',type:'aguda'},{word:'dragon',correct:'drag√≥n',type:'aguda'},{word:'jabon',correct:'jab√≥n',type:'aguda'},
                {word:'ladron',correct:'ladr√≥n',type:'aguda'},{word:'marron',correct:'marr√≥n',type:'aguda'},{word:'nacion',correct:'naci√≥n',type:'aguda'},
                {word:'pantalon',correct:'pantal√≥n',type:'aguda'},{word:'sarten',correct:'sart√©n',type:'aguda'},{word:'tambien',correct:'tambi√©n',type:'aguda'},
                {word:'ningun',correct:'ning√∫n',type:'aguda'},{word:'algun',correct:'alg√∫n',type:'aguda'},{word:'comun',correct:'com√∫n',type:'aguda'},
                {word:'atun',correct:'at√∫n',type:'aguda'},{word:'delfin',correct:'delf√≠n',type:'aguda'},{word:'jardin',correct:'jard√≠n',type:'aguda'},
                {word:'violin',correct:'viol√≠n',type:'aguda'},{word:'patin',correct:'pat√≠n',type:'aguda'},{word:'calcetin',correct:'calcet√≠n',type:'aguda'},
                {word:'trampolin',correct:'trampol√≠n',type:'aguda'},{word:'cajon',correct:'caj√≥n',type:'aguda'},{word:'tiburon',correct:'tibur√≥n',type:'aguda'},
                {word:'perdon',correct:'perd√≥n',type:'aguda'},{word:'bombon',correct:'bomb√≥n',type:'aguda'},{word:'campeon',correct:'campe√≥n',type:'aguda'},
                {word:'cancion',correct:'canci√≥n',type:'aguda'},{word:'leccion',correct:'lecci√≥n',type:'aguda'},{word:'emocion',correct:'emoci√≥n',type:'aguda'},
                {word:'adios',correct:'adi√≥s',type:'aguda'},{word:'despues',correct:'despu√©s',type:'aguda'},{word:'ingles',correct:'ingl√©s',type:'aguda'},
                {word:'frances',correct:'franc√©s',type:'aguda'},{word:'japones',correct:'japon√©s',type:'aguda'},{word:'portugues',correct:'portugu√©s',type:'aguda'},
                {word:'cortes',correct:'cort√©s',type:'aguda'},{word:'marques',correct:'marqu√©s',type:'aguda'},{word:'compas',correct:'comp√°s',type:'aguda'},
                {word:'quizas',correct:'quiz√°s',type:'aguda'},{word:'jamas',correct:'jam√°s',type:'aguda'},{word:'ademas',correct:'adem√°s',type:'aguda'},
                {word:'detras',correct:'detr√°s',type:'aguda'},{word:'autobus',correct:'autob√∫s',type:'aguda'},{word:'canto',correct:'cant√≥',type:'aguda'},
                {word:'bailo',correct:'bail√≥',type:'aguda'},{word:'salto',correct:'salt√≥',type:'aguda'},{word:'jugo',correct:'jug√≥',type:'aguda'},
                {word:'pinto',correct:'pint√≥',type:'aguda'},{word:'estudio',correct:'estudi√≥',type:'aguda'},{word:'camino',correct:'camin√≥',type:'aguda'},
                {word:'corrio',correct:'corri√≥',type:'aguda'},{word:'subio',correct:'subi√≥',type:'aguda'},{word:'comio',correct:'comi√≥',type:'aguda'},
                {word:'bebio',correct:'bebi√≥',type:'aguda'},{word:'durmio',correct:'durmi√≥',type:'aguda'},{word:'salio',correct:'sali√≥',type:'aguda'},
                {word:'entro',correct:'entr√≥',type:'aguda'},{word:'miro',correct:'mir√≥',type:'aguda'},{word:'escucho',correct:'escuch√≥',type:'aguda'},
                {word:'hablo',correct:'habl√≥',type:'aguda'},{word:'llamo',correct:'llam√≥',type:'aguda'},{word:'llego',correct:'lleg√≥',type:'aguda'},
                {word:'paso',correct:'pas√≥',type:'aguda'},{word:'penso',correct:'pens√≥',type:'aguda'},{word:'volo',correct:'vol√≥',type:'aguda'},
                {word:'gano',correct:'gan√≥',type:'aguda'},{word:'perdio',correct:'perdi√≥',type:'aguda'},{word:'encontro',correct:'encontr√≥',type:'aguda'},
                {word:'cayo',correct:'cay√≥',type:'aguda'},{word:'oyo',correct:'oy√≥',type:'aguda'},{word:'leyo',correct:'ley√≥',type:'aguda'}
            ],
            llanas: [
                {word:'arbol',correct:'√°rbol',type:'llana'},{word:'facil',correct:'f√°cil',type:'llana'},{word:'dificil',correct:'dif√≠cil',type:'llana'},
                {word:'util',correct:'√∫til',type:'llana'},{word:'fragil',correct:'fr√°gil',type:'llana'},{word:'agil',correct:'√°gil',type:'llana'},
                {word:'habil',correct:'h√°bil',type:'llana'},{word:'debil',correct:'d√©bil',type:'llana'},{word:'movil',correct:'m√≥vil',type:'llana'},
                {word:'fertil',correct:'f√©rtil',type:'llana'},{word:'docil',correct:'d√≥cil',type:'llana'},{word:'portatil',correct:'port√°til',type:'llana'},
                {word:'crater',correct:'cr√°ter',type:'llana'},{word:'caracter',correct:'car√°cter',type:'llana'},{word:'martir',correct:'m√°rtir',type:'llana'},
                {word:'nectar',correct:'n√©ctar',type:'llana'},{word:'azucar',correct:'az√∫car',type:'llana'},{word:'almibar',correct:'alm√≠bar',type:'llana'},
                {word:'ambar',correct:'√°mbar',type:'llana'},{word:'cancer',correct:'c√°ncer',type:'llana'},{word:'cadaver',correct:'cad√°ver',type:'llana'},
                {word:'trebol',correct:'tr√©bol',type:'llana'},{word:'tunel',correct:'t√∫nel',type:'llana'},{word:'angel',correct:'√°ngel',type:'llana'},
                {word:'carcel',correct:'c√°rcel',type:'llana'},{word:'futbol',correct:'f√∫tbol',type:'llana'},{word:'beisbol',correct:'b√©isbol',type:'llana'},
                {word:'poster',correct:'p√≥ster',type:'llana'},{word:'hamster',correct:'h√°mster',type:'llana'},{word:'lider',correct:'l√≠der',type:'llana'},
                {word:'super',correct:'s√∫per',type:'llana'},{word:'pixel',correct:'p√≠xel',type:'llana'},{word:'album',correct:'√°lbum',type:'llana'},
                {word:'consul',correct:'c√≥nsul',type:'llana'},{word:'lapiz',correct:'l√°piz',type:'llana'},{word:'caliz',correct:'c√°liz',type:'llana'},
                {word:'fenix',correct:'f√©nix',type:'llana'},{word:'torax',correct:'t√≥rax',type:'llana'},{word:'climax',correct:'cl√≠max',type:'llana'},
                {word:'biceps',correct:'b√≠ceps',type:'llana'},{word:'triceps',correct:'tr√≠ceps',type:'llana'},{word:'record',correct:'r√©cord',type:'llana'},
                {word:'cesped',correct:'c√©sped',type:'llana'},{word:'huesped',correct:'hu√©sped',type:'llana'},{word:'marmol',correct:'m√°rmol',type:'llana'},
                {word:'mastil',correct:'m√°stil',type:'llana'},{word:'fosil',correct:'f√≥sil',type:'llana'},{word:'datil',correct:'d√°til',type:'llana'},
                {word:'dolar',correct:'d√≥lar',type:'llana'},{word:'comic',correct:'c√≥mic',type:'llana'}
            ],
            esdrujulas: [
                {word:'pajaro',correct:'p√°jaro',type:'esdrujula'},{word:'murcielago',correct:'murci√©lago',type:'esdrujula'},{word:'libelula',correct:'lib√©lula',type:'esdrujula'},
                {word:'mamifero',correct:'mam√≠fero',type:'esdrujula'},{word:'brujula',correct:'br√∫jula',type:'esdrujula'},{word:'camara',correct:'c√°mara',type:'esdrujula'},
                {word:'lampara',correct:'l√°mpara',type:'esdrujula'},{word:'maquina',correct:'m√°quina',type:'esdrujula'},{word:'fabrica',correct:'f√°brica',type:'esdrujula'},
                {word:'capsula',correct:'c√°psula',type:'esdrujula'},{word:'sabana',correct:'s√°bana',type:'esdrujula'},{word:'platano',correct:'pl√°tano',type:'esdrujula'},
                {word:'piramide',correct:'pir√°mide',type:'esdrujula'},{word:'pelicula',correct:'pel√≠cula',type:'esdrujula'},{word:'mascara',correct:'m√°scara',type:'esdrujula'},
                {word:'lagrima',correct:'l√°grima',type:'esdrujula'},{word:'pagina',correct:'p√°gina',type:'esdrujula'},{word:'silaba',correct:'s√≠laba',type:'esdrujula'},
                {word:'formula',correct:'f√≥rmula',type:'esdrujula'},{word:'celula',correct:'c√©lula',type:'esdrujula'},{word:'molecula',correct:'mol√©cula',type:'esdrujula'},
                {word:'america',correct:'Am√©rica',type:'esdrujula'},{word:'africa',correct:'√Åfrica',type:'esdrujula'},{word:'oceano',correct:'oc√©ano',type:'esdrujula'},
                {word:'atlantico',correct:'atl√°ntico',type:'esdrujula'},{word:'pacifico',correct:'pac√≠fico',type:'esdrujula'},{word:'peninsula',correct:'pen√≠nsula',type:'esdrujula'},
                {word:'fantastico',correct:'fant√°stico',type:'esdrujula'},{word:'magnifico',correct:'magn√≠fico',type:'esdrujula'},{word:'ridiculo',correct:'rid√≠culo',type:'esdrujula'},
                {word:'tipico',correct:'t√≠pico',type:'esdrujula'},{word:'clasico',correct:'cl√°sico',type:'esdrujula'},{word:'romantico',correct:'rom√°ntico',type:'esdrujula'},
                {word:'dramatico',correct:'dram√°tico',type:'esdrujula'},{word:'tragico',correct:'tr√°gico',type:'esdrujula'},{word:'comico',correct:'c√≥mico',type:'esdrujula'},
                {word:'logico',correct:'l√≥gico',type:'esdrujula'},{word:'historico',correct:'hist√≥rico',type:'esdrujula'},{word:'geografico',correct:'geogr√°fico',type:'esdrujula'},
                {word:'biologico',correct:'biol√≥gico',type:'esdrujula'},{word:'ecologico',correct:'ecol√≥gico',type:'esdrujula'},{word:'tecnologico',correct:'tecnol√≥gico',type:'esdrujula'},
                {word:'cientifico',correct:'cient√≠fico',type:'esdrujula'},{word:'publico',correct:'p√∫blico',type:'esdrujula'},{word:'medico',correct:'m√©dico',type:'esdrujula'},
                {word:'quimico',correct:'qu√≠mico',type:'esdrujula'},{word:'fisico',correct:'f√≠sico',type:'esdrujula'},{word:'telefono',correct:'tel√©fono',type:'esdrujula'},
                {word:'microfono',correct:'micr√≥fono',type:'esdrujula'},{word:'semaforo',correct:'sem√°foro',type:'esdrujula'},{word:'helicoptero',correct:'helic√≥ptero',type:'esdrujula'},
                {word:'termometro',correct:'term√≥metro',type:'esdrujula'},{word:'kilometro',correct:'kil√≥metro',type:'esdrujula'},{word:'musica',correct:'m√∫sica',type:'esdrujula'},
                {word:'matematicas',correct:'matem√°ticas',type:'esdrujula'},{word:'gramatica',correct:'gram√°tica',type:'esdrujula'},{word:'numero',correct:'n√∫mero',type:'esdrujula'},
                {word:'espiritu',correct:'esp√≠ritu',type:'esdrujula'},{word:'capitulo',correct:'cap√≠tulo',type:'esdrujula'},{word:'titulo',correct:'t√≠tulo',type:'esdrujula'},
                {word:'credito',correct:'cr√©dito',type:'esdrujula'},{word:'codigo',correct:'c√≥digo',type:'esdrujula'},{word:'metodo',correct:'m√©todo',type:'esdrujula'},
                {word:'periodo',correct:'per√≠odo',type:'esdrujula'},{word:'proposito',correct:'prop√≥sito',type:'esdrujula'},{word:'simbolo',correct:'s√≠mbolo',type:'esdrujula'},
                {word:'estimulo',correct:'est√≠mulo',type:'esdrujula'},{word:'angulo',correct:'√°ngulo',type:'esdrujula'},{word:'musculo',correct:'m√∫sculo',type:'esdrujula'},
                {word:'calculo',correct:'c√°lculo',type:'esdrujula'},{word:'vinculo',correct:'v√≠nculo',type:'esdrujula'},{word:'obstaculo',correct:'obst√°culo',type:'esdrujula'},
                {word:'curriculo',correct:'curr√≠culo',type:'esdrujula'},{word:'vehiculo',correct:'veh√≠culo',type:'esdrujula'},{word:'particula',correct:'part√≠cula',type:'esdrujula'},
                {word:'valvula',correct:'v√°lvula',type:'esdrujula'},{word:'ultima',correct:'√∫ltima',type:'esdrujula'},{word:'ultimo',correct:'√∫ltimo',type:'esdrujula'},
                {word:'proximo',correct:'pr√≥ximo',type:'esdrujula'},{word:'maximo',correct:'m√°ximo',type:'esdrujula'},{word:'minimo',correct:'m√≠nimo',type:'esdrujula'},
                {word:'optimo',correct:'√≥ptimo',type:'esdrujula'},{word:'intimo',correct:'√≠ntimo',type:'esdrujula'},{word:'articulo',correct:'art√≠culo',type:'esdrujula'},
                {word:'espectaculo',correct:'espect√°culo',type:'esdrujula'},{word:'circulo',correct:'c√≠rculo',type:'esdrujula'},{word:'triangulo',correct:'tri√°ngulo',type:'esdrujula'}
            ],
            hiatos: [
                {word:'dia',correct:'d√≠a',type:'hiato'},{word:'tia',correct:'t√≠a',type:'hiato'},{word:'mia',correct:'m√≠a',type:'hiato'},
                {word:'fria',correct:'fr√≠a',type:'hiato'},{word:'sandia',correct:'sand√≠a',type:'hiato'},{word:'melodia',correct:'melod√≠a',type:'hiato'},
                {word:'energia',correct:'energ√≠a',type:'hiato'},{word:'fantasia',correct:'fantas√≠a',type:'hiato'},{word:'compania',correct:'compa√±√≠a',type:'hiato'},
                {word:'geografia',correct:'geograf√≠a',type:'hiato'},{word:'biografia',correct:'biograf√≠a',type:'hiato'},{word:'filosofia',correct:'filosof√≠a',type:'hiato'},
                {word:'tecnologia',correct:'tecnolog√≠a',type:'hiato'},{word:'biologia',correct:'biolog√≠a',type:'hiato'},{word:'psicologia',correct:'psicolog√≠a',type:'hiato'},
                {word:'alegria',correct:'alegr√≠a',type:'hiato'},{word:'valentia',correct:'valent√≠a',type:'hiato'},{word:'simpatia',correct:'simpat√≠a',type:'hiato'},
                {word:'cortesia',correct:'cortes√≠a',type:'hiato'},{word:'panaderia',correct:'panader√≠a',type:'hiato'},{word:'libreria',correct:'librer√≠a',type:'hiato'},
                {word:'joyeria',correct:'joyer√≠a',type:'hiato'},{word:'cafeteria',correct:'cafeter√≠a',type:'hiato'},{word:'rio',correct:'r√≠o',type:'hiato'},
                {word:'frio',correct:'fr√≠o',type:'hiato'},{word:'mio',correct:'m√≠o',type:'hiato'},{word:'lio',correct:'l√≠o',type:'hiato'},
                {word:'navio',correct:'nav√≠o',type:'hiato'},{word:'desafio',correct:'desaf√≠o',type:'hiato'},{word:'rocio',correct:'roc√≠o',type:'hiato'},
                {word:'vacio',correct:'vac√≠o',type:'hiato'},{word:'pua',correct:'p√∫a',type:'hiato'},{word:'grua',correct:'gr√∫a',type:'hiato'},
                {word:'continua',correct:'contin√∫a',type:'hiato'},{word:'actua',correct:'act√∫a',type:'hiato'},{word:'evalua',correct:'eval√∫a',type:'hiato'},
                {word:'buho',correct:'b√∫ho',type:'hiato'},{word:'duo',correct:'d√∫o',type:'hiato'},{word:'pais',correct:'pa√≠s',type:'hiato'},
                {word:'maiz',correct:'ma√≠z',type:'hiato'},{word:'raiz',correct:'ra√≠z',type:'hiato'},{word:'oir',correct:'o√≠r',type:'hiato'},
                {word:'reir',correct:'re√≠r',type:'hiato'},{word:'freir',correct:'fre√≠r',type:'hiato'},{word:'baul',correct:'ba√∫l',type:'hiato'},
                {word:'ataud',correct:'ata√∫d',type:'hiato'},{word:'caida',correct:'ca√≠da',type:'hiato'},{word:'oido',correct:'o√≠do',type:'hiato'},
                {word:'leido',correct:'le√≠do',type:'hiato'},{word:'creido',correct:'cre√≠do',type:'hiato'},{word:'traido',correct:'tra√≠do',type:'hiato'}
            ],
            diacritica: [
                {frase:'_____ ni√±o come helado',correcta:'El',incorrecta:'√âl'},{frase:'_____ es mi mejor amigo',correcta:'√âl',incorrecta:'El'},
                {frase:'Dile a _____ que venga',correcta:'√©l',incorrecta:'el'},{frase:'_____ perro ladra mucho',correcta:'El',incorrecta:'√âl'},
                {frase:'_____ eres muy listo',correcta:'T√∫',incorrecta:'Tu'},{frase:'Dame _____ mochila',correcta:'tu',incorrecta:'t√∫'},
                {frase:'¬øVienes _____ tambi√©n?',correcta:'t√∫',incorrecta:'tu'},{frase:'_____ casa es bonita',correcta:'Tu',incorrecta:'T√∫'},
                {frase:'Esto es para _____',correcta:'m√≠',incorrecta:'mi'},{frase:'_____ hermano es alto',correcta:'Mi',incorrecta:'M√≠'},
                {frase:'A _____ me gusta el f√∫tbol',correcta:'m√≠',incorrecta:'mi'},{frase:'Dame _____ libro',correcta:'mi',incorrecta:'m√≠'},
                {frase:'_____ quiero ir',correcta:'S√≠',incorrecta:'Si'},{frase:'_____ llueve, no salimos',correcta:'Si',incorrecta:'S√≠'},
                {frase:'Dijo que _____',correcta:'s√≠',incorrecta:'si'},{frase:'_____ estudias, aprobar√°s',correcta:'Si',incorrecta:'S√≠'},
                {frase:'Quiero _____ agua',correcta:'m√°s',incorrecta:'mas'},{frase:'Lo intent√≥, _____ no pudo',correcta:'mas',incorrecta:'m√°s'},
                {frase:'¬øQuieres un _____?',correcta:'t√©',incorrecta:'te'},{frase:'_____ quiero mucho',correcta:'Te',incorrecta:'T√©'},
                {frase:'El _____ est√° caliente',correcta:'t√©',incorrecta:'te'},{frase:'_____ lo dije ayer',correcta:'Te',incorrecta:'T√©'},
                {frase:'Yo _____ la respuesta',correcta:'s√©',incorrecta:'se'},{frase:'_____ cay√≥ al suelo',correcta:'Se',incorrecta:'S√©'},
                {frase:'Quiero que me lo _____',correcta:'d√©',incorrecta:'de'},{frase:'La casa _____ madera',correcta:'de',incorrecta:'d√©'},
                {frase:'_____ no ha llegado',correcta:'A√∫n',incorrecta:'Aun'},{frase:'_____ as√≠ lo intent√≥',correcta:'Aun',incorrecta:'A√∫n'}
            ]
        };

        // CAMBIO: Solo 3 palabras por mundo para rotar m√°s r√°pido
        const WORLDS = [
            {id:'castle',name:'üè∞ Castillo',wordsPerWorld:3,bgClass:'bg-castle',platformClass:'platform-castle',ladderClass:'ladder-castle'},
            {id:'forest',name:'üå≤ Bosque',wordsPerWorld:3,bgClass:'bg-forest',platformClass:'platform-forest',ladderClass:'ladder-forest'},
            {id:'ocean',name:'üåä Oc√©ano',wordsPerWorld:3,bgClass:'bg-ocean',platformClass:'platform-ocean',ladderClass:'ladder-ocean'},
            {id:'space',name:'üöÄ Espacio',wordsPerWorld:3,bgClass:'bg-space',platformClass:'platform-space',ladderClass:'ladder-space'},
            {id:'candy',name:'üç¨ Reino Dulce',wordsPerWorld:3,bgClass:'bg-candy',platformClass:'platform-candy',ladderClass:'ladder-candy'}
        ];

        let gameState = {
            numPlayers:1,mode:'competitive',currentPlayer:0,players:[],
            currentWorldIndex:0, // √çndice del mundo actual
            wordsInCurrentWorld:0, // Contador de palabras en el mundo actual
            isPlaying:false,isPaused:false,currentWord:null,collectedTilde:false,
            usedWords:new Set(),coopGoal:500,
            selectedVowelIndex:-1,selectedClassification:null,tildeCorrect:false,accentedWord:'',
            // Nuevos elementos adictivos
            combo:0,
            streak:0,
            powerups:[],
            activeEffects:{shield:false,speed:false,magnet:false,time:false},
            perfectLevel:true // Se pone a false si falla una vez
        };

        let player = {x:100,y:500,vx:0,vy:0,width:40,height:55,speed:5,jumpForce:-13,gravity:0.6,onGround:false,onLadder:false,isClimbing:false,facingRight:true};
        let platforms=[],ladders=[],activeTilde=null,enemies=[],keys={},touchStates={left:false,right:false,up:false,down:false,jump:false};
        let gameLoopId=null,enemySpawnInterval=null,tildeInterval=null;
        let lastWalkSound = 0;

        function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}

        function selectPlayers(num){
            playSound('click');
            gameState.numPlayers=num;
            document.querySelectorAll('.player-option').forEach(p=>p.classList.remove('selected'));
            document.querySelector(`[data-players="${num}"]`).classList.add('selected');
            if(num===1)startGame();else setTimeout(()=>showScreen('mode-screen'),200);
        }

        function selectMode(mode){
            playSound('click');
            gameState.mode=mode;
            document.querySelectorAll('.mode-option').forEach(m=>m.classList.remove('selected'));
            document.querySelector(`[data-mode="${mode}"]`).classList.add('selected');
            setTimeout(()=>startGame(),200);
        }

        function startGame(){
            initAudio();
            gameState.players=[];
            for(let i=0;i<gameState.numPlayers;i++)gameState.players.push({name:`J${i+1}`,score:0,lives:3});
            gameState.currentPlayer=0;
            gameState.currentWorldIndex=0; // Empezar en el primer mundo
            gameState.wordsInCurrentWorld=0;
            gameState.usedWords=new Set();
            gameState.isPlaying=true;
            // Resetear elementos adictivos
            gameState.combo = 0;
            gameState.streak = 0;
            gameState.perfectLevel = true;
            gameState.activeEffects = {shield:false,speed:false,magnet:false,time:false};
            if('ontouchstart' in window)document.getElementById('touch-controls').classList.add('active');
            showScreen('game-screen');showWorldIntro();
        }

        function getCurrentWorld(){return WORLDS[gameState.currentWorldIndex];}

        function showWorldIntro(){
            gameState.isPaused=true;
            if(enemySpawnInterval){clearInterval(enemySpawnInterval);enemySpawnInterval=null;}
            if(tildeInterval){clearInterval(tildeInterval);tildeInterval=null;}
            const world=getCurrentWorld();
            document.getElementById('world-intro-name').textContent=world.name;
            document.getElementById('world-intro-level').textContent=`Mundo ${gameState.currentWorldIndex+1}/${WORLDS.length}`;
            document.getElementById('world-intro').classList.add('active');
            playSound('levelup');
            setTimeout(()=>{document.getElementById('world-intro').classList.remove('active');initLevel();},2000);
        }

        function initLevel(){
            const gameArea=document.getElementById('game-area');gameArea.innerHTML='';
            platforms=[];ladders=[];activeTilde=null;enemies=[];gameState.powerups=[];
            if(tildeInterval){clearInterval(tildeInterval);tildeInterval=null;}
            const world=getCurrentWorld();
            createWorldBackground(world);createPlatforms(world);createLadders(world);createGoalZone();
            player.x=100;player.y=520;player.vx=0;player.vy=0;gameState.collectedTilde=false;gameState.isPaused=false;
            // Resetear efectos al iniciar nivel
            gameState.activeEffects = {shield:false,speed:false,magnet:false,time:false};
            gameState.perfectLevel = true;
            createPlayerSprite();updateHUD();updateCollectedIndicator();selectNewWord();
            if(gameLoopId)cancelAnimationFrame(gameLoopId);gameLoop();startEnemySpawner();
            startPowerupSpawner();
        }

        // FONDOS √öNICOS POR MUNDO
        function createWorldBackground(world){
            const gameArea=document.getElementById('game-area');
            const bg=document.createElement('div');bg.className=`world-bg ${world.bgClass}`;
            
            if(world.id==='castle'){
                bg.innerHTML=`
                    <div class="castle-tower" style="left:5%;height:180px;"><div class="castle-window" style="top:40px;left:50%;transform:translateX(-50%);"></div></div>
                    <div class="castle-tower" style="left:25%;height:220px;"><div class="castle-window" style="top:60px;left:50%;transform:translateX(-50%);"></div><div class="castle-window" style="top:120px;left:50%;transform:translateX(-50%);"></div></div>
                    <div class="castle-tower" style="right:15%;height:200px;"><div class="castle-window" style="top:50px;left:50%;transform:translateX(-50%);"></div></div>
                    <div class="castle-tower" style="right:5%;height:160px;"><div class="castle-window" style="top:30px;left:50%;transform:translateX(-50%);"></div></div>
                    <div class="moon" style="top:30px;right:50px;"></div>
                `;
            }
            else if(world.id==='forest'){
                bg.innerHTML=`
                    <div class="tree" style="left:8%;height:140px;"></div>
                    <div class="tree" style="left:35%;height:180px;"></div>
                    <div class="tree" style="right:20%;height:160px;"></div>
                    <div class="tree" style="right:5%;height:130px;"></div>
                    <div class="sun" style="top:20px;right:60px;"></div>
                `;
            }
            else if(world.id==='ocean'){
                bg.innerHTML=`
                    <div class="coral" style="left:10%;height:70px;"></div>
                    <div class="coral" style="left:30%;height:90px;animation-delay:1s;"></div>
                    <div class="seaweed" style="left:55%;height:120px;"></div>
                    <div class="seaweed" style="left:70%;height:80px;animation-delay:0.5s;"></div>
                    <div class="coral" style="right:10%;height:60px;animation-delay:2s;"></div>
                    ${Array(8).fill(0).map((_,i)=>`<div class="bubble" style="left:${Math.random()*100}%;bottom:${Math.random()*50}px;animation-delay:${Math.random()*4}s;"></div>`).join('')}
                `;
            }
            else if(world.id==='space'){
                bg.innerHTML=`
                    <div class="planet-bg" style="width:60px;height:60px;background:linear-gradient(135deg,#E57373 0%,#C62828 100%);top:40px;left:10%;"></div>
                    <div class="planet-bg" style="width:40px;height:40px;background:linear-gradient(135deg,#64B5F6 0%,#1565C0 100%);top:100px;right:15%;"></div>
                    <div class="asteroid" style="top:150px;animation-duration:25s;"></div>
                    <div class="asteroid" style="top:250px;animation-duration:30s;animation-delay:5s;"></div>
                    ${Array(50).fill(0).map((_,i)=>`<div class="star" style="left:${Math.random()*100}%;top:${Math.random()*100}%;animation-delay:${Math.random()*2}s;"></div>`).join('')}
                `;
            }
            else if(world.id==='candy'){
                bg.innerHTML=`
                    <div class="candy-cane" style="left:15%;"></div>
                    <div class="candy-cane" style="left:40%;transform:rotate(15deg);"></div>
                    <div class="gumdrop" style="left:60%;background:linear-gradient(180deg,#9C27B0 0%,#7B1FA2 100%);"></div>
                    <div class="gumdrop" style="right:20%;background:linear-gradient(180deg,#4CAF50 0%,#388E3C 100%);"></div>
                    <div class="lollipop" style="right:5%;bottom:20px;"><div class="lollipop-candy" style="background:conic-gradient(#E91E63 0deg,white 60deg,#E91E63 120deg,white 180deg,#E91E63 240deg,white 300deg,#E91E63 360deg);"></div><div class="lollipop-stick"></div></div>
                `;
            }
            gameArea.appendChild(bg);
        }

        // PLATAFORMAS - TODAS IGUALES DE LARGAS
        function createPlatforms(world){
            const gameArea=document.getElementById('game-area');
            const gw=gameArea.offsetWidth||900;
            const platformWidth = gw - 100; // Todas iguales de largas
            
            let configs;
            
            switch(world.id){
                case 'castle':
                    configs=[
                        {y:580,x:0,width:gw}, // Suelo completo
                        {y:460,x:50,width:platformWidth}, // Plataforma 2
                        {y:340,x:50,width:platformWidth}, // Plataforma 3
                        {y:220,x:50,width:platformWidth}, // Plataforma 4
                        {y:100,x:50,width:platformWidth}  // Plataforma meta - IGUAL DE LARGA
                    ];
                    break;
                    
                case 'forest':
                    configs=[
                        {y:580,x:0,width:gw},
                        {y:465,x:50,width:platformWidth},
                        {y:350,x:50,width:platformWidth},
                        {y:240,x:50,width:platformWidth},
                        {y:110,x:50,width:platformWidth}
                    ];
                    break;
                    
                case 'ocean':
                    configs=[
                        {y:580,x:0,width:gw},
                        {y:450,x:50,width:platformWidth},
                        {y:340,x:50,width:platformWidth},
                        {y:215,x:50,width:platformWidth},
                        {y:95,x:50,width:platformWidth}
                    ];
                    break;
                    
                case 'space':
                    configs=[
                        {y:580,x:0,width:gw},
                        {y:460,x:50,width:platformWidth},
                        {y:335,x:50,width:platformWidth},
                        {y:210,x:50,width:platformWidth},
                        {y:90,x:50,width:platformWidth}
                    ];
                    break;
                    
                case 'candy':
                    configs=[
                        {y:580,x:0,width:gw},
                        {y:475,x:50,width:platformWidth},
                        {y:365,x:50,width:platformWidth},
                        {y:250,x:50,width:platformWidth},
                        {y:120,x:50,width:platformWidth}
                    ];
                    break;
                    
                default:
                    configs=[
                        {y:580,x:0,width:gw},
                        {y:460,x:50,width:platformWidth},
                        {y:340,x:50,width:platformWidth},
                        {y:220,x:50,width:platformWidth},
                        {y:100,x:50,width:platformWidth}
                    ];
            }
            
            configs.forEach((c,i)=>{
                const p=document.createElement('div');
                p.className=`platform ${world.platformClass}`;
                p.style.left=c.x+'px';
                p.style.top=c.y+'px';
                p.style.width=c.width+'px';
                gameArea.appendChild(p);
                platforms.push({x:c.x,y:c.y,width:c.width,height:18});
            });
        }

        // ESCALERAS - AHORA 2 POR PLATAFORMA
        function createLadders(world){
            const gameArea=document.getElementById('game-area');
            const ladderClass = world.ladderClass || 'ladder-castle';
            const gw = gameArea.offsetWidth||900;
            
            // Crear 2 escaleras entre cada par de plataformas
            for(let i=0;i<platforms.length-1;i++){
                const top=platforms[i+1];
                const bottom=platforms[i];
                
                // Primera escalera - izquierda
                const xPos1 = top.x + 80 + Math.random() * 50;
                const l1=document.createElement('div');
                l1.className=`ladder ${ladderClass}`;
                l1.style.left=Math.floor(xPos1)+'px';
                l1.style.top=top.y+'px';
                l1.style.height=(bottom.y-top.y)+'px';
                gameArea.appendChild(l1);
                ladders.push({x:Math.floor(xPos1),y:top.y,width:32,height:bottom.y-top.y});
                
                // Segunda escalera - derecha (si hay espacio)
                const xPos2 = top.x + top.width - 130 - Math.random() * 50;
                if(xPos2 > xPos1 + 80) { // Solo si hay suficiente espacio
                    const l2=document.createElement('div');
                    l2.className=`ladder ${ladderClass}`;
                    l2.style.left=Math.floor(xPos2)+'px';
                    l2.style.top=top.y+'px';
                    l2.style.height=(bottom.y-top.y)+'px';
                    gameArea.appendChild(l2);
                    ladders.push({x:Math.floor(xPos2),y:top.y,width:32,height:bottom.y-top.y});
                }
            }
        }

        function createGoalZone(){
            const g=document.createElement('div');
            g.className='goal-zone';
            g.textContent='üéØ META';
            document.getElementById('game-area').appendChild(g);
        }

        function createPlayerSprite(){
            const gameArea=document.getElementById('game-area');
            const p=document.createElement('div');p.className='player';p.id='player-sprite';
            p.innerHTML=`<div class="player-sprite"><div class="player-head"><div class="player-hair"></div><div class="player-eyes"><div class="player-eye"></div><div class="player-eye"></div></div></div><div class="player-body"></div><div class="player-arms"><div class="player-arm"><div class="player-hand"></div></div><div class="player-arm"><div class="player-hand"></div></div></div><div class="player-legs"><div class="player-leg"><div class="player-shoe"></div></div><div class="player-leg"><div class="player-shoe"></div></div></div></div>`;
            p.style.left=player.x+'px';p.style.top=player.y+'px';gameArea.appendChild(p);
        }

        function selectNewWord(){
            const world=getCurrentWorld();
            if(world.id==='candy'){
                const unused=WORD_BANK.diacritica.filter(w=>!gameState.usedWords.has(JSON.stringify(w)));
                if(unused.length>0){
                    const sel=unused[Math.floor(Math.random()*unused.length)];
                    gameState.usedWords.add(JSON.stringify(sel));gameState.currentWord={type:'diacritica',data:sel};
                    document.getElementById('word-display').textContent=sel.frase.replace('_____','___');return;
                }
            }
            const allWords=[...WORD_BANK.agudas,...WORD_BANK.llanas,...WORD_BANK.esdrujulas,...WORD_BANK.hiatos];
            const unused=allWords.filter(w=>!gameState.usedWords.has(w.word));
            let sel;
            if(unused.length>0){sel=unused[Math.floor(Math.random()*unused.length)];gameState.usedWords.add(sel.word);}
            else{gameState.usedWords.clear();sel=allWords[Math.floor(Math.random()*allWords.length)];gameState.usedWords.add(sel.word);}
            gameState.currentWord={type:'normal',data:sel};
            document.getElementById('word-display').textContent=sel.word.toUpperCase();
            startTildeSpawner();
        }

        function getTildeDifficulty(){
            const level = gameState.currentWorldIndex + 1; // Basado en el mundo
            let visibleTime = Math.max(1800, 4500 - (level * 200));
            let hiddenTime = Math.min(2500, 800 + (level * 100));
            let speed = Math.min(6, 1.8 + (level * 0.5));
            let fleeSpeed = Math.min(8, 3.5 + (level * 0.6));
            
            // Power-up de tiempo
            if(gameState.activeEffects.time) {
                visibleTime *= 1.5;
            }
            
            return { visibleTime, hiddenTime, speed, fleeSpeed };
        }

        function startTildeSpawner(){
            if(tildeInterval){clearInterval(tildeInterval);tildeInterval=null;}
            if(gameState.collectedTilde || gameState.currentWord.type==='diacritica') return;
            spawnTilde();
        }

        function createTildeHTML() {
            return `
                <div class="tilde-sparkles">
                    <div class="tilde-sparkle"></div>
                    <div class="tilde-sparkle"></div>
                    <div class="tilde-sparkle"></div>
                    <div class="tilde-sparkle"></div>
                </div>
                <div class="banana-tilde-body">
                    <div class="banana-tilde-inner"></div>
                    <div class="banana-tilde-highlight"></div>
                    <div class="banana-tilde-tip-top"></div>
                    <div class="banana-tilde-tip-bottom"></div>
                    <div class="banana-tilde-face">
                        <div class="banana-tilde-eyes">
                            <div class="banana-tilde-eye"><div class="banana-tilde-pupil"></div></div>
                            <div class="banana-tilde-eye"><div class="banana-tilde-pupil"></div></div>
                        </div>
                        <div class="banana-tilde-mouth"></div>
                    </div>
                </div>
                <div class="banana-tilde-legs">
                    <div class="banana-tilde-leg"><div class="banana-tilde-shoe"></div></div>
                    <div class="banana-tilde-leg"><div class="banana-tilde-shoe"></div></div>
                </div>
                <div class="tilde-timer"><div class="tilde-timer-bar" id="tilde-timer-bar"></div></div>
            `;
        }

        function spawnTilde(){
            if(gameState.collectedTilde || !gameState.isPlaying || gameState.isPaused) return;
            if(gameState.currentWord && gameState.currentWord.type==='diacritica') return;
            
            if(activeTilde && activeTilde.element){
                activeTilde.element.remove();
                activeTilde = null;
            }
            
            const gameArea=document.getElementById('game-area');
            const difficulty = getTildeDifficulty();
            
            const t=document.createElement('div');
            t.className='tilde-character running appearing';
            t.innerHTML = createTildeHTML();
            
            const platIndex = 1 + Math.floor(Math.random() * 3);
            const plat = platforms[platIndex];
            
            const xPos = plat.x + 60 + Math.random() * (plat.width - 120);
            t.style.left = xPos + 'px';
            t.style.top = (plat.y - 65) + 'px';
            
            gameArea.appendChild(t);
            playSound('appear');
            
            setTimeout(() => {
                t.classList.remove('appearing');
            }, 500);
            
            activeTilde = {
                element: t,
                x: xPos,
                y: plat.y - 65,
                width: 50,
                height: 65,
                vx: (Math.random() > 0.5 ? 1 : -1) * difficulty.speed,
                platformIndex: platIndex,
                visible: true,
                spawnTime: Date.now(),
                visibleDuration: difficulty.visibleTime
            };
            
            // Timer visual
            const timerBar = t.querySelector('#tilde-timer-bar');
            if(timerBar) {
                let elapsed = 0;
                const timerInterval = setInterval(() => {
                    if(!activeTilde || gameState.collectedTilde) {
                        clearInterval(timerInterval);
                        return;
                    }
                    elapsed += 100;
                    const remaining = Math.max(0, 1 - (elapsed / difficulty.visibleTime));
                    timerBar.style.width = (remaining * 100) + '%';
                    if(remaining < 0.3) timerBar.style.background = 'linear-gradient(90deg, #f44336 0%, #ff5722 100%)';
                }, 100);
            }
            
            setTimeout(() => {
                hideTilde();
            }, difficulty.visibleTime);
        }

        function hideTilde(){
            if(!activeTilde || gameState.collectedTilde) return;
            
            playSound('disappear');
            if(activeTilde.element){
                activeTilde.element.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                activeTilde.element.style.opacity = '0';
                activeTilde.element.style.transform = 'scale(0.5)';
                setTimeout(() => {
                    if(activeTilde && activeTilde.element){
                        activeTilde.element.remove();
                        activeTilde = null;
                    }
                    const difficulty = getTildeDifficulty();
                    setTimeout(() => {
                        if(!gameState.collectedTilde && gameState.isPlaying && !gameState.isPaused){
                            spawnTilde();
                        }
                    }, difficulty.hiddenTime);
                }, 300);
            }
        }

        // NUEVO: Sistema de Power-ups
        function startPowerupSpawner(){
            setInterval(() => {
                if(!gameState.isPlaying || gameState.isPaused || gameState.collectedTilde) return;
                if(Math.random() > 0.7) spawnPowerup(); // 30% de probabilidad cada intervalo
            }, 8000);
        }

        function spawnPowerup(){
            const gameArea = document.getElementById('game-area');
            const types = [
                {type: 'shield', icon: 'üõ°Ô∏è', class: 'powerup-shield', duration: 10000},
                {type: 'speed', icon: '‚ö°', class: 'powerup-speed', duration: 8000},
                {type: 'magnet', icon: 'üß≤', class: 'powerup-magnet', duration: 6000},
                {type: 'time', icon: '‚è∞', class: 'powerup-time', duration: 0}
            ];
            
            const powerupType = types[Math.floor(Math.random() * types.length)];
            const platIndex = 1 + Math.floor(Math.random() * 3);
            const plat = platforms[platIndex];
            
            const p = document.createElement('div');
            p.className = `powerup ${powerupType.class}`;
            p.textContent = powerupType.icon;
            p.dataset.type = powerupType.type;
            p.dataset.duration = powerupType.duration;
            
            const xPos = plat.x + 100 + Math.random() * (plat.width - 200);
            p.style.left = xPos + 'px';
            p.style.top = (plat.y - 40) + 'px';
            
            gameArea.appendChild(p);
            gameState.powerups.push({
                element: p,
                x: xPos,
                y: plat.y - 40,
                width: 35,
                height: 35,
                type: powerupType.type,
                duration: powerupType.duration
            });
            
            // Desaparecer despu√©s de 5 segundos si no se recoge
            setTimeout(() => {
                if(p.parentNode) {
                    p.style.animation = 'disappear 0.3s ease forwards';
                    setTimeout(() => p.remove(), 300);
                }
            }, 5000);
        }

        function collectPowerup(powerup){
            playSound('powerup');
            createParticles(powerup.x + 17, powerup.y + 17, '#9C27B0');
            
            switch(powerup.type){
                case 'shield':
                    gameState.activeEffects.shield = true;
                    document.getElementById('player-sprite').classList.add('shielded');
                    setTimeout(() => {
                        gameState.activeEffects.shield = false;
                        document.getElementById('player-sprite').classList.remove('shielded');
                    }, powerup.duration);
                    break;
                case 'speed':
                    gameState.activeEffects.speed = true;
                    player.speed = 8; // Velocidad aumentada
                    document.getElementById('player-sprite').classList.add('speed-boost');
                    setTimeout(() => {
                        gameState.activeEffects.speed = false;
                        player.speed = 5;
                        document.getElementById('player-sprite').classList.remove('speed-boost');
                    }, powerup.duration);
                    break;
                case 'magnet':
                    gameState.activeEffects.magnet = true;
                    setTimeout(() => {
                        gameState.activeEffects.magnet = false;
                    }, powerup.duration);
                    break;
                case 'time':
                    gameState.activeEffects.time = true;
                    // El tiempo se maneja en getTildeDifficulty
                    setTimeout(() => {
                        gameState.activeEffects.time = false;
                    }, 10000);
                    break;
            }
            
            powerup.element.remove();
            gameState.powerups = gameState.powerups.filter(p => p !== powerup);
        }

        function createParticles(x, y, color){
            const gameArea = document.getElementById('game-area');
            for(let i = 0; i < 8; i++){
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.background = color;
                const angle = (i / 8) * Math.PI * 2;
                const distance = 30 + Math.random() * 20;
                particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
                particle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
                particle.style.animation = `particleExplode 0.6s ease-out forwards`;
                gameArea.appendChild(particle);
                setTimeout(() => particle.remove(), 600);
            }
        }

        function startEnemySpawner(){
            if(enemySpawnInterval)clearInterval(enemySpawnInterval);
            const rate=Math.max(2000,4500-(gameState.currentWorldIndex*500));
            enemySpawnInterval=setInterval(()=>{if(!gameState.isPaused&&gameState.isPlaying)spawnEnemy();},rate);
        }

        function spawnEnemy(){
            const gameArea=document.getElementById('game-area');const gameWidth=gameArea.offsetWidth||900;
            const e=document.createElement('div');e.className='enemy pencil-enemy falling';
            e.innerHTML=`<div class="pencil-top"></div><div class="pencil-body"><div class="pencil-face"><div class="pencil-brows"><div class="pencil-brow"></div><div class="pencil-brow"></div></div><div class="pencil-eyes"><div class="pencil-eye"></div><div class="pencil-eye"></div></div></div></div><div class="pencil-tip"></div>`;
            const x=80+Math.random()*(gameWidth-160);e.style.left=x+'px';e.style.top='-70px';gameArea.appendChild(e);
            enemies.push({element:e,x:x,y:-70,width:18,height:70,vy:2.5+Math.random()*2+(gameState.currentWorldIndex*0.5),vx:(Math.random()-0.5)*3});
        }

        function gameLoop(){
            if(!gameState.isPlaying)return;
            if(!gameState.isPaused){update();render();}
            gameLoopId=requestAnimationFrame(gameLoop);
        }

        function update(){handleInput();updatePlayer();updateTilde();updateEnemies();checkCollisions();updatePowerups();}

        function updatePowerups(){
            // Efecto de im√°n
            if(gameState.activeEffects.magnet && activeTilde && !gameState.collectedTilde){
                const dx = player.x - activeTilde.x;
                const dy = player.y - activeTilde.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                if(dist < 150 && dist > 10){
                    activeTilde.x += (dx / dist) * 3;
                    activeTilde.y += (dy / dist) * 3;
                    activeTilde.element.style.left = activeTilde.x + 'px';
                    activeTilde.element.style.top = activeTilde.y + 'px';
                }
            }
        }

        function handleInput(){
            const ms = gameState.activeEffects.speed ? 8 : 5;
            if(keys['ArrowLeft']||keys['KeyA']||touchStates.left){player.vx=-ms;player.facingRight=false;}
            else if(keys['ArrowRight']||keys['KeyD']||touchStates.right){player.vx=ms;player.facingRight=true;}
            else player.vx=0;
            if(player.onLadder){
                if(keys['ArrowUp']||keys['KeyW']||touchStates.up){player.vy=-ms*0.7;player.isClimbing=true;}
                else if(keys['ArrowDown']||keys['KeyS']||touchStates.down){player.vy=ms*0.7;player.isClimbing=true;}
                else{player.vy=0;player.isClimbing=false;}
            }
            if((keys['Space']||touchStates.jump)&&player.onGround&&!player.onLadder){
                player.vy=player.jumpForce;player.onGround=false;
                playSound('jump');
                keys['Space']=false;touchStates.jump=false;
            }
        }

        function updatePlayer(){
            const pe=document.getElementById('player-sprite');if(!pe)return;
            if(!player.onLadder)player.vy+=player.gravity;
            player.x+=player.vx;player.y+=player.vy;
            const ga=document.getElementById('game-area');const gw=ga.offsetWidth||900;const gh=ga.offsetHeight||700;
            player.x=Math.max(0,Math.min(gw-player.width,player.x));player.y=Math.max(0,Math.min(gh-player.height,player.y));
            player.onGround=false;player.onLadder=false;
            ladders.forEach(l=>{if(player.x+player.width>l.x&&player.x<l.x+l.width&&player.y+player.height>l.y&&player.y<l.y+l.height)player.onLadder=true;});
            const wantsClimbDown=player.onLadder&&(keys['ArrowDown']||keys['KeyS']||touchStates.down);
            platforms.forEach(p=>{if(!wantsClimbDown&&player.x+player.width>p.x&&player.x<p.x+p.width&&player.y+player.height>p.y&&player.y+player.height<p.y+p.height+15&&player.vy>=0){player.y=p.y-player.height;player.vy=0;player.onGround=true;}});
            pe.style.left=player.x+'px';pe.style.top=player.y+'px';pe.style.transform=player.facingRight?'scaleX(1)':'scaleX(-1)';
            
            const isWalking = Math.abs(player.vx)>0.5&&player.onGround;
            pe.classList.toggle('walking',isWalking);
            
            if(isWalking && Date.now() - lastWalkSound > 250){
                playSound('walk');
                lastWalkSound = Date.now();
            }
        }

        function updateTilde(){
            if(!activeTilde||gameState.collectedTilde)return;
            
            const difficulty = getTildeDifficulty();
            const plat=platforms[activeTilde.platformIndex];
            
            activeTilde.x+=activeTilde.vx;
            
            if(activeTilde.x<plat.x+10){
                activeTilde.x=plat.x+10;
                activeTilde.vx*=-1;
            }
            if(activeTilde.x>plat.x+plat.width-activeTilde.width-10){
                activeTilde.x=plat.x+plat.width-activeTilde.width-10;
                activeTilde.vx*=-1;
            }
            
            const dx=player.x-activeTilde.x,dy=player.y-activeTilde.y,dist=Math.sqrt(dx*dx+dy*dy);
            if(dist<100){
                activeTilde.vx=(dx>0?-1:1)*difficulty.fleeSpeed;
            }else if(Math.abs(activeTilde.vx)>difficulty.speed){
                activeTilde.vx*=0.96;
            }
            
            activeTilde.element.style.left=activeTilde.x+'px';
            activeTilde.element.style.transform=activeTilde.vx>0?'scaleX(-1)':'scaleX(1)';
        }

        function updateEnemies(){
            const ga=document.getElementById('game-area');const gh=ga.offsetHeight||700;const gw=ga.offsetWidth||900;
            enemies.forEach((e,i)=>{
                e.y+=e.vy;e.x+=e.vx;if(e.x<0||e.x>gw-e.width)e.vx*=-1;
                e.element.style.left=e.x+'px';e.element.style.top=e.y+'px';
                if(e.y>gh){e.element.remove();enemies.splice(i,1);}
            });
        }

        function checkCollisions(){
            // Colisi√≥n con tilde
            if(activeTilde&&!gameState.collectedTilde&&player.x<activeTilde.x+activeTilde.width&&player.x+player.width>activeTilde.x&&player.y<activeTilde.y+activeTilde.height&&player.y+player.height>activeTilde.y)collectTilde();
            
            // Colisi√≥n con power-ups
            gameState.powerups.forEach(p => {
                if(player.x < p.x + p.width && player.x + player.width > p.x &&
                   player.y < p.y + p.height && player.y + player.height > p.y){
                    collectPowerup(p);
                }
            });
            
            // Colisi√≥n con enemigos
            enemies.forEach((e, i)=>{
                if(player.x<e.x+e.width&&player.x+player.width>e.x&&player.y<e.y+e.height&&player.y+player.height>e.y){
                    if(gameState.activeEffects.shield){
                        // Destruir enemigo con escudo
                        createParticles(e.x + 9, e.y + 35, '#FDD835');
                        e.element.remove();
                        enemies.splice(i, 1);
                        playSound('hit');
                        addScore(25); // Bonus por destruir enemigo
                    } else {
                        hitByEnemy();
                    }
                }
            });
            
            const canReachGoal=gameState.collectedTilde||(gameState.currentWord&&gameState.currentWord.type==='diacritica');
            if(player.y<120&&canReachGoal)reachGoal();
        }

        function collectTilde(){
            gameState.collectedTilde=true;
            activeTilde.element.classList.remove('running');
            activeTilde.element.classList.add('collected');
            playSound('collect');
            createParticles(activeTilde.x + 25, activeTilde.y + 32, '#FFD54F');
            if(tildeInterval){clearInterval(tildeInterval);tildeInterval=null;}
            setTimeout(()=>{if(activeTilde){activeTilde.element.remove();activeTilde=null;}},500);
            updateCollectedIndicator();
        }

        function updateCollectedIndicator(){
            const ind=document.getElementById('collected-indicator');const pre=document.getElementById('collected-preview');
            if(gameState.collectedTilde){pre.textContent='¬¥';ind.classList.add('active');}else ind.classList.remove('active');
        }

        function reachGoal(){
            gameState.isPaused=true;const world=getCurrentWorld();
            if(tildeInterval){clearInterval(tildeInterval);tildeInterval=null;}
            playSound('click');
            if(world.id==='candy')showDiacriticModal();else showTildeModal();
        }

        function showTildeModal(){
            const m=document.getElementById('tilde-modal');const wc=document.getElementById('tilde-word');
            const word=gameState.currentWord.data.word;wc.innerHTML='';
            const vowels='aeiouAEIOU';
            for(let i=0;i<word.length;i++){
                const s=document.createElement('span');s.className='letter-box';s.textContent=word[i].toUpperCase();s.dataset.index=i;
                if(vowels.includes(word[i])){s.classList.add('vowel');s.onclick=()=>selectVowel(s,i);}
                wc.appendChild(s);
            }
            gameState.selectedVowelIndex=-1;document.getElementById('tilde-confirm-btn').disabled=true;m.classList.add('active');
        }

        function selectVowel(el,idx){
            playSound('click');
            document.querySelectorAll('#tilde-word .letter-box').forEach(l=>l.classList.remove('selected'));
            el.classList.add('selected');gameState.selectedVowelIndex=idx;document.getElementById('tilde-confirm-btn').disabled=false;
        }

        function confirmTildePlacement(){
            if(gameState.selectedVowelIndex<0)return;
            playSound('click');
            const word=gameState.currentWord.data.word;const correct=gameState.currentWord.data.correct;
            const map={'a':'√°','e':'√©','i':'√≠','o':'√≥','u':'√∫'};
            let attempt='';for(let i=0;i<word.length;i++)attempt+=(i===gameState.selectedVowelIndex&&map[word[i].toLowerCase()])?map[word[i].toLowerCase()]:word[i];
            gameState.tildeCorrect=attempt.toLowerCase()===correct.toLowerCase();gameState.accentedWord=gameState.tildeCorrect?correct:attempt;
            document.getElementById('tilde-modal').classList.remove('active');showClassifyModal();
        }

        function showClassifyModal(){
            document.getElementById('classify-word-display').textContent=gameState.accentedWord.toUpperCase();
            document.querySelectorAll('.class-option').forEach(o=>o.classList.remove('selected'));
            gameState.selectedClassification=null;document.getElementById('class-confirm-btn').disabled=true;
            document.getElementById('classify-modal').classList.add('active');
        }

        function selectClassification(type){
            playSound('click');
            document.querySelectorAll('.class-option').forEach(o=>o.classList.remove('selected'));
            event.target.classList.add('selected');gameState.selectedClassification=type;document.getElementById('class-confirm-btn').disabled=false;
        }

        function confirmClassification(){
            if(!gameState.selectedClassification)return;
            const correctType=gameState.currentWord.data.type;const classCorrect=gameState.selectedClassification===correctType;
            document.getElementById('classify-modal').classList.remove('active');
            
            // Sistema de puntuaci√≥n mejorado con combo
            let basePoints = 0;
            let multiplier = 1 + Math.floor(gameState.combo / 3); // Multiplicador cada 3 aciertos
            
            if(gameState.tildeCorrect&&classCorrect){
                basePoints = 150;
                gameState.streak++;
                gameState.combo++;
                playSound('correct');
                showFeedback(true,`¬°PERFECTO! x${multiplier}`);
                createFloatingScore(player.x, player.y, basePoints * multiplier);
            } else if(gameState.tildeCorrect){
                basePoints = 50;
                gameState.streak++;
                gameState.combo++;
                playSound('correct');
                showFeedback(true,`¬°BIEN! +${basePoints * multiplier}`);
                createFloatingScore(player.x, player.y, basePoints * multiplier);
            } else {
                basePoints = 0;
                gameState.combo = 0; // Reset combo al fallar
                gameState.perfectLevel = false;
                playSound('wrong');
                showFeedback(false,'¬°INCORRECTO!');
                loseLife();
                return; // No continuar si fall√≥
            }
            
            // Actualizar UI de combo
            updateComboDisplay();
            
            addScore(basePoints * multiplier);
            nextWord();
        }

        function createFloatingScore(x, y, points){
            const gameArea = document.getElementById('game-area');
            const fs = document.createElement('div');
            fs.className = 'floating-score';
            fs.textContent = '+' + points;
            fs.style.left = (x + 20) + 'px';
            fs.style.top = (y - 20) + 'px';
            gameArea.appendChild(fs);
            setTimeout(() => fs.remove(), 1000);
        }

        function updateComboDisplay(){
            const comboDisplay = document.getElementById('combo-display');
            const comboCount = document.getElementById('combo-count');
            const streakIndicator = document.getElementById('streak-indicator');
            const streakCount = document.getElementById('streak-count');
            
            if(gameState.combo > 1){
                comboDisplay.classList.add('active');
                comboCount.textContent = 'x' + (1 + Math.floor(gameState.combo / 3));
                if(gameState.combo % 3 === 0) playSound('combo');
            } else {
                comboDisplay.classList.remove('active');
            }
            
            if(gameState.streak > 2){
                streakIndicator.classList.add('active');
                streakCount.textContent = gameState.streak;
            } else {
                streakIndicator.classList.remove('active');
            }
        }

        function showDiacriticModal(){
            const m=document.getElementById('diacritic-modal');const s=document.getElementById('diacritic-sentence');const o=document.getElementById('diacritic-options');
            const d=gameState.currentWord.data;s.textContent=d.frase;o.innerHTML='';
            [d.correcta,d.incorrecta].sort(()=>Math.random()-0.5).forEach(opt=>{
                const b=document.createElement('button');b.className='diacritic-btn';b.textContent=opt;
                b.onclick=()=>checkDiacriticAnswer(opt,d.correcta);o.appendChild(b);
            });
            m.classList.add('active');
        }

        function checkDiacriticAnswer(sel,cor){
            document.getElementById('diacritic-modal').classList.remove('active');
            let multiplier = 1 + Math.floor(gameState.combo / 3);
            
            if(sel===cor){
                gameState.streak++;
                gameState.combo++;
                playSound('correct');
                showFeedback(true,`¬°CORRECTO! x${multiplier}`);
                createFloatingScore(player.x, player.y, 100 * multiplier);
                addScore(100 * multiplier);
                updateComboDisplay();
                nextWord();
            } else {
                gameState.combo = 0;
                gameState.perfectLevel = false;
                playSound('wrong');
                showFeedback(false,'¬°INCORRECTO!');
                loseLife();
            }
        }

        function showFeedback(success,text){
            const f=document.getElementById('feedback');f.textContent=text;f.className='feedback '+(success?'show-correct':'show-incorrect');
            setTimeout(()=>f.className='feedback',1200);
        }

        function addScore(pts){gameState.players[gameState.currentPlayer].score+=pts;updateHUD();}

        // CAMBIO IMPORTANTE: Cambiar de mundo cada 3 palabras
        function nextWord(){
            gameState.wordsInCurrentWorld++;
            const world = getCurrentWorld();
            
            // Actualizar barra de progreso
            const progress = (gameState.wordsInCurrentWorld / world.wordsPerWorld) * 100;
            document.getElementById('world-progress-bar').style.width = progress + '%';
            
            // Cambiar de mundo cada 3 palabras
            if(gameState.wordsInCurrentWorld >= world.wordsPerWorld){
                // Mostrar mensaje de nivel perfecto si aplica
                if(gameState.perfectLevel){
                    const perfectMsg = document.getElementById('perfect-level');
                    perfectMsg.classList.add('active');
                    addScore(200); // Bonus por nivel perfecto
                    setTimeout(() => perfectMsg.classList.remove('active'), 2000);
                }
                
                gameState.wordsInCurrentWorld = 0;
                gameState.currentWorldIndex++;
                gameState.combo = 0; // Reset combo entre mundos
                updateComboDisplay();
                
                // Si hemos pasado todos los mundos, volver al primero o terminar
                if(gameState.currentWorldIndex >= WORLDS.length){
                    endGame();
                    return;
                }
                
                showWorldIntro();
            } else {
                resetForNextWord();
            }
        }

        function resetForNextWord(){
            player.x=100;player.y=520;player.vx=0;player.vy=0;
            gameState.collectedTilde=false;gameState.isPaused=false;
            if(tildeInterval){clearInterval(tildeInterval);tildeInterval=null;}
            updateCollectedIndicator();selectNewWord();
        }

        function hitByEnemy(){
            playSound('hit');
            loseLife();
        }

        function loseLife(){
            const currentPlayer = gameState.players[gameState.currentPlayer];
            currentPlayer.lives--;
            
            // Efecto visual de p√©rdida de vida
            const hearts = document.querySelectorAll('.heart');
            if(currentPlayer.lives >= 0 && currentPlayer.lives < hearts.length){
                hearts[currentPlayer.lives].classList.add('lost');
            }
            
            updateHUD();
            
            if(currentPlayer.lives <= 0){
                // Jugador eliminado - verificar si quedan otros
                const alivePlayers = gameState.players.filter(p => p.lives > 0);
                if(alivePlayers.length === 0){
                    endGame();
                } else {
                    // Cambiar al siguiente jugador vivo
                    switchPlayer();
                }
            } else {
                // CORRECCI√ìN IMPORTANTE: Continuar con el mismo jugador, solo resetear posici√≥n
                resetPlayerPosition();
                showFeedback(false, '¬°Cuidado! -1 vida');
            }
        }

        function switchPlayer(){
            // Encontrar el siguiente jugador con vidas
            let nextPlayer = (gameState.currentPlayer + 1) % gameState.numPlayers;
            let attempts = 0;
            
            while(gameState.players[nextPlayer].lives <= 0 && attempts < gameState.numPlayers){
                nextPlayer = (nextPlayer + 1) % gameState.numPlayers;
                attempts++;
            }
            
            if(attempts >= gameState.numPlayers){
                // Todos los jugadores eliminados
                endGame();
                return;
            }
            
            gameState.currentPlayer = nextPlayer;
            document.getElementById('transition-player').textContent=`Jugador ${gameState.currentPlayer+1}`;
            document.getElementById('player-transition').classList.add('active');
            gameState.isPaused=true;
        }

        function continueAfterTransition(){
            playSound('click');
            document.getElementById('player-transition').classList.remove('active');
            gameState.isPaused=false;
            resetPlayerPosition();
            updateHUD();
        }

        function resetPlayerPosition(){
            player.x=100;player.y=520;player.vx=0;player.vy=0;
            gameState.collectedTilde=false;
            gameState.isPaused=false;
            updateCollectedIndicator();
            if(tildeInterval){clearInterval(tildeInterval);tildeInterval=null;}
            if(gameState.currentWord&&gameState.currentWord.type!=='diacritica')startTildeSpawner();
        }

        function playerEliminated(){
            const alive=gameState.players.filter(p=>p.lives>0);
            if(alive.length===0) endGame();
            else switchPlayer();
        }

        function endGame(){
            gameState.isPlaying=false;
            if(enemySpawnInterval)clearInterval(enemySpawnInterval);
            if(tildeInterval)clearInterval(tildeInterval);
            if(gameLoopId)cancelAnimationFrame(gameLoopId);
            playSound('levelup');
            showResults();
        }

        function showResults(){
            const rc=document.getElementById('results-content');
            if(gameState.mode==='cooperative'){
                const total=gameState.players.reduce((s,p)=>s+p.score,0);const success=total>=gameState.coopGoal;
                rc.innerHTML=`<div class="coop-result"><div class="coop-total">${total} puntos</div><div class="coop-goal">Objetivo: ${gameState.coopGoal}</div><div class="coop-status">${success?'üéâ ¬°CONSEGUIDO!':'üò¢ ¬°Casi!'}</div></div>`;
            }else{
                const sorted=[...gameState.players].sort((a,b)=>b.score-a.score);
                let html='<div class="podium">';
                if(sorted.length>=2)html+=`<div class="podium-place second"><div class="podium-medal">ü•à</div><div class="podium-name">${sorted[1].name}</div><div class="podium-score">${sorted[1].score}</div></div>`;
                html+=`<div class="podium-place first"><div class="podium-medal">ü•á</div><div class="podium-name">${sorted[0].name}</div><div class="podium-score">${sorted[0].score}</div></div>`;
                if(sorted.length>=3)html+=`<div class="podium-place third"><div class="podium-medal">ü•â</div><div class="podium-name">${sorted[2].name}</div><div class="podium-score">${sorted[2].score}</div></div>`;
                html+='</div>';rc.innerHTML=html;
            }
            showScreen('results-screen');
        }

        function updateHUD(){
            const cp=gameState.players[gameState.currentPlayer];
            document.getElementById('current-player-badge').textContent=`J${gameState.currentPlayer+1}`;
            const ld=document.getElementById('lives-display');ld.innerHTML='';
            for(let i=0;i<3;i++){
                const h=document.createElement('span');
                h.className='heart'+(i>=cp.lives?' lost':'');
                h.textContent='‚ù§Ô∏è';
                ld.appendChild(h);
            }
            document.getElementById('score-display').textContent=cp.score;
            document.getElementById('level-display').textContent=`${gameState.currentWorldIndex+1}/${WORLDS.length}`;
            document.getElementById('world-badge').textContent=getCurrentWorld().name;
        }

        function render(){}
        function pauseGame(){
            gameState.isPaused=true;
            document.getElementById('pause-overlay').classList.add('active');
        }
        function resumeGame(){
            playSound('click');
            gameState.isPaused=false;
            document.getElementById('pause-overlay').classList.remove('active');
        }
        function quitToMenu(){
            playSound('click');
            gameState.isPlaying=false;
            if(enemySpawnInterval)clearInterval(enemySpawnInterval);
            if(tildeInterval)clearInterval(tildeInterval);
            if(gameLoopId)cancelAnimationFrame(gameLoopId);
            document.getElementById('pause-overlay').classList.remove('active');
            showScreen('menu-screen');
        }
        function playAgain(){
            playSound('click');
            showScreen('players-screen');
        }

        document.addEventListener('keydown',e=>{
            keys[e.code]=true;
            if(e.code==='Escape'&&gameState.isPlaying){
                const modalsOpen=document.getElementById('tilde-modal').classList.contains('active')||document.getElementById('classify-modal').classList.contains('active')||document.getElementById('diacritic-modal').classList.contains('active');
                if(gameState.isPaused&&!modalsOpen)resumeGame();else if(!gameState.isPaused)pauseGame();
            }
            if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Space'].includes(e.code))e.preventDefault();
        });
        document.addEventListener('keyup',e=>keys[e.code]=false);

        function setupTouchControls(){
            const btns={'btn-left':'left','btn-right':'right','btn-up':'up','btn-down':'down','btn-jump':'jump'};
            Object.entries(btns).forEach(([id,st])=>{
                const b=document.getElementById(id);if(b){
                    b.addEventListener('touchstart',e=>{e.preventDefault();touchStates[st]=true;});
                    b.addEventListener('touchend',e=>{e.preventDefault();touchStates[st]=false;});
                    b.addEventListener('touchcancel',()=>touchStates[st]=false);
                    b.addEventListener('mousedown',()=>touchStates[st]=true);
                    b.addEventListener('mouseup',()=>touchStates[st]=false);
                    b.addEventListener('mouseleave',()=>touchStates[st]=false);
                }
            });
        }
        document.addEventListener('DOMContentLoaded',setupTouchControls);
        document.addEventListener('touchmove',e=>{if(e.scale!==1)e.preventDefault();},{passive:false});

        document.addEventListener('click', initAudio, { once: true });
        document.addEventListener('touchstart', initAudio, { once: true });
    </script>
</body>
</html>